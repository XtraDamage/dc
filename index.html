<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doolcoin Evolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { brand: { black: '#080808', dark: '#121212', accent: '#FF4D00', gray: '#1C1C1E' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #080808; color: white; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(28, 28, 30, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.04); }
        .sunset-gradient { background: linear-gradient(135deg, #FF8A00 0%, #FF4D00 100%); }
        .btn-press:active { transform: scale(0.96); }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased font-sans">

    <div id="app" class="relative w-full max-w-[450px] mx-auto h-[100dvh] flex flex-col overflow-hidden bg-brand-black">
        
        <!-- LOADING SCREEN -->
        <div id="view-loading" class="absolute inset-0 z-50 bg-black flex items-center justify-center transition-opacity duration-300">
            <div class="w-10 h-10 border-4 border-white/10 border-t-brand-accent rounded-full animate-spin"></div>
        </div>

        <!-- AUTH SCREEN -->
        <div id="view-auth" class="hidden flex-col h-full p-8 justify-center">
            <h1 class="text-4xl font-extrabold mb-2">Doolcoin</h1>
            <p class="text-neutral-500 mb-8">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Email –±–µ–∑ –ø–∞—Ä–æ–ª—è</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email-input" placeholder="–í–∞—à–∞ –ø–æ—á—Ç–∞" class="w-full bg-brand-gray border border-white/5 rounded-2xl px-5 py-4 outline-none focus:border-brand-accent text-sm" required>
                <button type="submit" class="w-full sunset-gradient text-white font-bold py-4 rounded-2xl btn-press shadow-lg shadow-brand-accent/20">–í–æ–π—Ç–∏</button>
            </form>
            <p id="auth-msg" class="mt-4 text-center text-xs text-neutral-400 hidden">–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ—á—Ç—É!</p>
        </div>

        <!-- MAIN DASHBOARD -->
        <div id="view-dashboard" class="hidden flex-col h-full opacity-0 transition-opacity duration-500">
            <header class="p-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-brand-gray flex items-center justify-center font-bold text-brand-accent border border-white/5" id="avatar-circle">?</div>
                    <div>
                        <div class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider" id="name-label">–í–∞—à ID</div>
                        <div class="text-sm font-semibold flex items-center gap-1">
                            <span id="user-id-text">#0000</span>
                            <button onclick="copy('user-id-text')" class="opacity-30 hover:opacity-100 transition-opacity">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openModal('settings')" class="w-10 h-10 rounded-full bg-brand-gray flex items-center justify-center text-neutral-400 border border-white/5 btn-press">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </button>
                    <button id="logout-btn" class="w-10 h-10 rounded-full bg-brand-gray flex items-center justify-center text-neutral-400 border border-white/5 btn-press">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto hide-scroll px-6 pb-20">
                <div class="py-10 text-center">
                    <p class="text-neutral-500 text-xs font-bold uppercase tracking-widest mb-2">–ë–∞–ª–∞–Ω—Å</p>
                    <div class="text-6xl font-extrabold tracking-tighter"><span id="balance">0.00</span><span class="text-brand-accent ml-2 text-3xl">ƒê</span></div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-8">
                    <button onclick="openModal('send')" class="glass-card p-5 rounded-3xl flex flex-col items-center gap-2 btn-press">
                        <div class="w-12 h-12 rounded-2xl sunset-gradient flex items-center justify-center shadow-lg shadow-brand-accent/20">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>
                        </div>
                        <span class="text-xs font-bold">–ü–µ—Ä–µ–≤–æ–¥</span>
                    </button>
                    <button onclick="openModal('ref')" class="glass-card p-5 rounded-3xl flex flex-col items-center gap-2 btn-press">
                        <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                        </div>
                        <span class="text-xs font-bold">–ë–æ–Ω—É—Å—ã</span>
                    </button>
                </div>

                <div class="space-y-3" id="history">
                    <p class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest px-1">–ò—Å—Ç–æ—Ä–∏—è</p>
                    <div class="text-center py-10 text-neutral-600 text-xs">–û–ø–µ—Ä–∞—Ü–∏–π –Ω–µ—Ç</div>
                </div>
            </main>
        </div>

        <!-- MODAL SETTINGS -->
        <div id="modal-settings" class="fixed inset-0 z-50 bg-black/95 hidden flex-col p-6 animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button onclick="closeModal('settings')" class="w-10 h-10 rounded-full bg-brand-gray flex items-center justify-center">√ó</button>
            </div>
            
            <!-- Tabs -->
            <div class="flex bg-brand-gray rounded-2xl p-1 mb-8">
                <button onclick="setTab('profile')" id="btn-tab-profile" class="flex-1 py-3 rounded-xl text-sm font-bold bg-white text-black">–ü—Ä–æ—Ñ–∏–ª—å</button>
                <button onclick="setTab('safety')" id="btn-tab-safety" class="flex-1 py-3 rounded-xl text-sm font-bold text-neutral-500">–ó–∞—â–∏—Ç–∞</button>
            </div>

            <!-- Profile Tab -->
            <div id="tab-profile" class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] text-neutral-500 font-bold uppercase ml-2">–ò–º—è –≤ —Å–µ—Ç–∏</label>
                    <div class="flex gap-2">
                        <input type="text" id="name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º" class="flex-1 bg-brand-gray border border-white/5 rounded-2xl px-5 py-4 outline-none focus:border-brand-accent text-sm">
                        <button onclick="saveName()" class="px-6 sunset-gradient text-white font-bold rounded-2xl text-sm btn-press">–û–ö</button>
                    </div>
                </div>
                <div class="p-5 glass-card rounded-2xl text-xs text-neutral-400">–≠—Ç–æ –∏–º—è —É–≤–∏–¥—è—Ç –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç –≤–∞—Å –ø–µ—Ä–µ–≤–æ–¥–∞. –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –≤–∞—à ID.</div>
            </div>

            <!-- Safety Tab -->
            <div id="tab-safety" class="hidden space-y-4">
                <div class="flex gap-4 p-4 glass-card rounded-2xl border-l-4 border-green-500">
                    <div class="text-xl">üõ°Ô∏è</div>
                    <div class="text-[11px] text-neutral-400"><b class="text-white block mb-1">–ë–µ–∑ –ø–∞—Ä–æ–ª–µ–π</b>–í—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ –ø–æ—á—Ç—É. –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø–æ—á—Ç–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.</div>
                </div>
                <div class="flex gap-4 p-4 glass-card rounded-2xl border-l-4 border-blue-500">
                    <div class="text-xl">üîç</div>
                    <div class="text-[11px] text-neutral-400"><b class="text-white block mb-1">–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ ID</b>–ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–≤–µ—Ä—è–π—Ç–µ ID. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ Doolcoin –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</div>
                </div>
                <div class="flex gap-4 p-4 glass-card rounded-2xl border-l-4 border-brand-accent">
                    <div class="text-xl">üïµÔ∏è</div>
                    <div class="text-[11px] text-neutral-400"><b class="text-white block mb-1">–ì–∏–≥–∏–µ–Ω–∞</b>–ù–µ –≤–≤–æ–¥–∏—Ç–µ —Å–≤–æ–π Email –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å–∞–π—Ç–∞—Ö, –æ–±–µ—â–∞—é—â–∏—Ö —Ä–∞–∑–¥–∞—á–∏ –º–æ–Ω–µ—Ç.</div>
                </div>
            </div>
        </div>

        <!-- MODAL SEND -->
        <div id="modal-send" class="fixed inset-0 z-50 bg-black/90 hidden flex-col justify-end">
            <div class="bg-brand-dark rounded-t-[40px] p-8 border-t border-white/5">
                <h2 class="text-xl font-bold mb-6">–ü–µ—Ä–µ–≤–æ–¥</h2>
                <input type="text" id="send-id" placeholder="ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä. #ABCD)" class="w-full bg-brand-black border border-white/5 rounded-2xl p-4 text-white outline-none mb-4 uppercase">
                <input type="number" id="send-sum" placeholder="–°—É–º–º–∞ ƒê" class="w-full bg-brand-black border border-white/5 rounded-2xl p-4 text-white outline-none mb-6">
                <div class="flex gap-3">
                    <button onclick="closeModal('send')" class="flex-1 py-4 rounded-2xl bg-brand-gray font-bold btn-press">–û—Ç–º–µ–Ω–∞</button>
                    <button id="send-confirm" class="flex-[2] py-4 rounded-2xl sunset-gradient text-white font-bold btn-press">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- MODAL REF -->
        <div id="modal-ref" class="fixed inset-0 z-50 bg-black/90 hidden items-center justify-center p-6">
            <div class="glass-card w-full rounded-[40px] p-8 text-center">
                <h2 class="text-2xl font-bold mb-2">–ë–æ–Ω—É—Å 100 ƒê</h2>
                <p class="text-neutral-500 text-xs mb-6">–î–∞—Ä–∏–º –º–æ–Ω–µ—Ç—ã –≤–∞–º –∏ –¥—Ä—É–≥—É –ø—Ä–∏ –≤–≤–æ–¥–µ –µ–≥–æ –∫–æ–¥–∞.</p>
                <div class="bg-black/50 p-4 rounded-2xl border border-white/5 flex justify-between items-center mb-6">
                    <div class="text-left"><p class="text-[9px] text-neutral-500 font-bold uppercase">–í–∞—à –∫–æ–¥</p><p class="font-mono text-xl text-brand-accent font-bold" id="my-ref-code">...</p></div>
                    <button onclick="copy('my-ref-code')" class="p-3 bg-brand-gray rounded-xl">üìã</button>
                </div>
                <div id="ref-input-box">
                    <input type="text" id="ref-input" placeholder="–ö–æ–¥ –¥—Ä—É–≥–∞" class="w-full bg-brand-black border border-white/5 rounded-2xl p-4 text-center text-white mb-4 uppercase">
                    <button id="ref-apply" class="w-full py-4 rounded-2xl bg-white text-black font-bold btn-press">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <button onclick="closeModal('ref')" class="mt-4 text-neutral-600 font-bold text-sm">–ù–∞–∑–∞–¥</button>
            </div>
        </div>

        <!-- TOAST -->
        <div id="toast" class="absolute top-10 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full font-bold text-xs z-[100] shadow-2xl transition-all duration-300 -translate-y-24">Toast</div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, orderBy, limit, runTransaction, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBoFuGY-SSmcGHPGzuWZbdGFeI9_aaAKs8",
            authDomain: "doolcoinwallet.firebaseapp.com",
            projectId: "doolcoinwallet",
            storageBucket: "doolcoinwallet.firebasestorage.app",
            messagingSenderId: "473549726148",
            appId: "1:473549726148:web:87663b4944330c0df58491"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userState = null;

        // UI Helpers
        window.showToast = (m, err=false) => {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.style.background = err ? '#FF4D00' : 'white';
            t.style.color = err ? 'white' : 'black';
            t.classList.remove('-translate-y-24');
            setTimeout(() => t.classList.add('-translate-y-24'), 3000);
        };

        window.openModal = id => { document.getElementById('modal-'+id).classList.remove('hidden'); if(id==='ref') document.getElementById('modal-ref').classList.add('flex'); };
        window.closeModal = id => { document.getElementById('modal-'+id).classList.add('hidden'); if(id==='ref') document.getElementById('modal-ref').classList.remove('flex'); };
        window.copy = id => { navigator.clipboard.writeText(document.getElementById(id).textContent); showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); };

        window.setTab = t => {
            const isProf = t === 'profile';
            document.getElementById('tab-profile').classList.toggle('hidden', !isProf);
            document.getElementById('tab-safety').classList.toggle('hidden', isProf);
            document.getElementById('btn-tab-profile').className = isProf ? 'flex-1 py-3 rounded-xl text-sm font-bold bg-white text-black' : 'flex-1 py-3 rounded-xl text-sm font-bold text-neutral-500';
            document.getElementById('btn-tab-safety').className = !isProf ? 'flex-1 py-3 rounded-xl text-sm font-bold bg-white text-black' : 'flex-1 py-3 rounded-xl text-sm font-bold text-neutral-500';
        };

        // Auth Logic
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const uref = doc(db, "users", user.uid);
                const snap = await getDoc(uref);
                if (!snap.exists()) {
                    await setDoc(uref, {
                        email: user.email,
                        balance: 0,
                        displayName: '',
                        shortId: '#' + user.uid.substring(0, 4).toUpperCase(),
                        refUsed: false,
                        created: Timestamp.now()
                    });
                }
                startSync(user.uid);
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                setTimeout(() => document.getElementById('view-dashboard').classList.add('opacity-100'), 50);
            } else {
                if (isSignInWithEmailLink(auth, window.location.href)) {
                    let email = localStorage.getItem('emailForSignIn') || prompt('–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:');
                    if(email) {
                        try { await signInWithEmailLink(auth, email, window.location.href); localStorage.removeItem('emailForSignIn'); } 
                        catch(e) { showToast('–û—à–∏–±–∫–∞ —Å—Å—ã–ª–∫–∏', true); }
                    }
                }
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('view-auth').classList.remove('hidden');
            }
        });

        function startSync(uid) {
            onSnapshot(doc(db, "users", uid), d => {
                const data = d.data();
                if(!data) return;
                userState = data;
                document.getElementById('balance').textContent = data.balance.toFixed(2);
                document.getElementById('user-id-text').textContent = data.displayName || data.shortId;
                document.getElementById('name-label').textContent = data.displayName ? '–í–∞—à–µ –∏–º—è' : '–í–∞—à ID';
                document.getElementById('avatar-circle').textContent = (data.displayName || data.email)[0].toUpperCase();
                document.getElementById('my-ref-code').textContent = data.shortId.replace('#', '');
                document.getElementById('ref-input-box').classList.toggle('hidden', data.refUsed);
            });

            const q = query(collection(db, "transactions"), where("involved", "array-contains", uid), orderBy("date", "desc"), limit(15));
            onSnapshot(q, s => {
                const h = document.getElementById('history');
                h.innerHTML = '<p class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest px-1">–ò—Å—Ç–æ—Ä–∏—è</p>';
                if(s.empty) h.innerHTML += '<div class="text-center py-10 text-neutral-600 text-xs">–û–ø–µ—Ä–∞—Ü–∏–π –Ω–µ—Ç</div>';
                s.forEach(doc => {
                    const t = doc.data();
                    const inc = t.toUid === uid;
                    const el = document.createElement('div');
                    el.className = "flex items-center justify-between p-4 glass-card rounded-2xl";
                    el.innerHTML = `<div><div class="text-xs font-bold">${t.type === 'referral' ? 'üéÅ –ë–æ–Ω—É—Å' : (inc ? '‚Üì –í—Ö–æ–¥—è—â–∏–π' : '‚Üë –ü–µ—Ä–µ–≤–æ–¥')}</div><div class="text-[10px] text-neutral-500">${inc ? (t.fromName || t.fromId) : (t.toName || t.toId)}</div></div><div class="font-bold ${inc ? 'text-green-500' : 'text-white'}">${inc ? '+' : '-'}${t.amount.toFixed(2)}</div>`;
                    h.appendChild(el);
                });
            });
        }

        window.saveName = async () => {
            const n = document.getElementById('name-input').value.trim();
            if(n.length > 12) return showToast('–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –∏–º—è', true);
            try { await updateDoc(doc(db, "users", auth.currentUser.uid), { displayName: n }); showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); } catch(e) { showToast('–û—à–∏–±–∫–∞', true); }
        };

        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const em = document.getElementById('email-input').value;
            try { 
                await sendSignInLinkToEmail(auth, em, { url: window.location.href, handleCodeInApp: true });
                localStorage.setItem('emailForSignIn', em);
                document.getElementById('auth-msg').classList.remove('hidden');
            } catch(e) { showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', true); }
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // Core Actions
        document.getElementById('send-confirm').onclick = async () => {
            const id = document.getElementById('send-id').value.trim().toUpperCase();
            const sum = parseFloat(document.getElementById('send-sum').value);
            const fullId = id.startsWith('#') ? id : '#' + id;
            
            if(!sum || sum <= 0 || sum > userState.balance) return showToast('–û—à–∏–±–∫–∞ —Å—É–º–º—ã', true);
            if(fullId === userState.shortId) return showToast('–ù–µ–ª—å–∑—è —Å–µ–±–µ', true);

            try {
                await runTransaction(db, async (t) => {
                    const q = query(collection(db, "users"), where("shortId", "==", fullId));
                    const qs = await getDocs(q);
                    if(qs.empty) throw "ID –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    const rec = qs.docs[0];
                    const recData = rec.data();
                    t.update(doc(db, "users", auth.currentUser.uid), { balance: userState.balance - sum });
                    t.update(rec.ref, { balance: recData.balance + sum });
                    t.set(doc(collection(db, "transactions")), {
                        fromUid: auth.currentUser.uid, fromId: userState.shortId, fromName: userState.displayName,
                        toUid: rec.id, toId: fullId, toName: recData.displayName,
                        amount: sum, involved: [auth.currentUser.uid, rec.id], type: 'transfer', date: Timestamp.now()
                    });
                });
                showToast('–£—Å–ø–µ—à–Ω–æ'); closeModal('send');
            } catch(e) { showToast(e, true); }
        };

        document.getElementById('ref-apply').onclick = async () => {
            const code = document.getElementById('ref-input').value.trim().toUpperCase();
            const full = code.startsWith('#') ? code : '#' + code;
            if(full === userState.shortId) return showToast('–°–≤–æ–π –∫–æ–¥ –Ω–µ–ª—å–∑—è', true);
            try {
                await runTransaction(db, async (t) => {
                    const q = query(collection(db, "users"), where("shortId", "==", full));
                    const qs = await getDocs(q);
                    if(qs.empty) throw "–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    const inv = qs.docs[0];
                    const invD = inv.data();
                    t.update(doc(db, "users", auth.currentUser.uid), { balance: userState.balance + 100, refUsed: true });
                    t.update(inv.ref, { balance: invD.balance + 100 });
                    t.set(doc(collection(db, "transactions")), {
                        fromUid: inv.id, fromId: full, fromName: invD.displayName,
                        toUid: auth.currentUser.uid, toId: userState.shortId, toName: userState.displayName,
                        amount: 100, involved: [auth.currentUser.uid, inv.id], type: 'referral', date: Timestamp.now()
                    });
                });
                showToast('–ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª–µ–Ω'); closeModal('ref');
            } catch(e) { showToast(e, true); }
        };

    </script>
</body>
</html>