<!-- START OF FILE index_v2.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Doolcoin Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; box-sizing: border-box; }
        input { -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; user-select: text !important; }
        img { -webkit-user-drag: none; user-drag: none; pointer-events: none; }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (dvh) */
        body { 
            background-color: #050505; color: #fff; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; 
            height: 100dvh; /* Dynamic Viewport Height */
            width: 100vw;
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden;
        }
        
        /* UI Components */
        .dool-card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.05); }
        .gradient-text { background: linear-gradient(135deg, #FF4D00, #FF005C); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gradient-bg { background: linear-gradient(135deg, #FF4D00, #FF005C); }
        .token-gradient-text { background: linear-gradient(135deg, #00C9FF, #92FE9D); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .tab-content { display: none; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        /* Toast Notification */
        #toast { 
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%) translateY(-150%);
            width: auto; max-width: 92%; min-width: 300px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 999px;
            padding: 8px 16px 8px 8px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8);
            z-index: 200;
            display: flex; align-items: center; gap: 12px;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            opacity: 0; pointer-events: none;
        }
        #toast.active { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }

        /* Scanner */
        #modal-scan-content { position: relative; background: #000; }
        #reader { width: 100%; height: 100%; overflow: hidden; position: relative; }
        #reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }
        .scan-focus-area {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 260px; height: 260px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85);
            border-radius: 2.5rem; z-index: 10; pointer-events: none;
        }
        .scan-laser {
            position: absolute; width: 100%; height: 2px;
            background: #FF4D00; box-shadow: 0 0 15px #FF4D00;
            top: 50%; animation: scanAnim 2s infinite ease-in-out;
        }
        @keyframes scanAnim { 0%, 100% { transform: translateY(-100px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(100px); opacity: 0; } }

        /* Chart Animation */
        .chart-line {
            fill: none; stroke: #00C9FF; stroke-width: 3;
            stroke-dasharray: 1000; stroke-dashoffset: 1000;
            animation: drawChart 2.5s ease-out forwards;
            filter: drop-shadow(0 0 8px rgba(0,201,255,0.5));
        }
        @keyframes drawChart { to { stroke-dashoffset: 0; } }
        
        .swipe-zone { width: 100%; height: 32px; display: flex; align-items: center; justify-content: center; cursor: grab; touch-action: none; }
        .swipe-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- APP CONTAINER - Full Height Fixed -->
    <div id="app" class="w-full h-full sm:h-[95vh] sm:max-h-[850px] sm:max-w-[420px] sm:rounded-[3rem] relative bg-black shadow-2xl overflow-hidden border-0 sm:border border-white/10 flex flex-col">
        
        <!-- TOAST -->
        <div id="toast">
            <div class="relative shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-[#111] border border-white/10 overflow-hidden">
                <img id="toast-avatar" src="" class="w-full h-full object-cover hidden">
                <div id="toast-icon-sys" class="text-xl">üîî</div>
            </div>
            <div class="flex-1 min-w-0 flex flex-col justify-center">
                <p id="toast-title" class="text-[9px] font-black uppercase text-neutral-500 tracking-widest leading-tight">–°–∏—Å—Ç–µ–º–∞</p>
                <div class="flex items-baseline gap-2">
                    <p id="toast-msg" class="text-sm font-bold text-white truncate leading-tight">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</p>
                    <p id="toast-amount" class="text-sm font-black text-[#FF4D00] whitespace-nowrap hidden"></p>
                </div>
            </div>
        </div>

        <!-- LOADING -->
        <div id="view-loading" class="absolute inset-0 z-[100] bg-black flex items-center justify-center">
            <div class="relative">
                <div class="w-32 h-32 gradient-bg rounded-full blur-[60px] opacity-30 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
                <span class="text-8xl font-black gradient-text relative z-10 animate-pulse">ƒê</span>
            </div>
        </div>

        <!-- AUTH -->
        <div id="view-auth" class="hidden flex-col h-full p-6 justify-center relative">
            <div class="absolute top-0 left-0 w-full h-1/2 gradient-bg opacity-[0.03] blur-3xl pointer-events-none"></div>
            
            <button id="auth-ref-btn" onclick="openModal('invited-info')" class="hidden absolute top-6 left-6 z-30 group cursor-pointer">
                <div class="w-12 h-12 glass-panel rounded-full flex items-center justify-center text-2xl relative border border-white/10 group-hover:bg-white/10 transition-colors">
                    üéÅ
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping"></div>
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-black"></div>
                </div>
            </button>

            <div class="text-center mb-10 relative z-10">
                <span class="text-8xl font-black gradient-text inline-block mb-4">ƒê</span>
                <h1 class="text-4xl font-extrabold tracking-tight">Doolcoin</h1>
                <p class="text-neutral-500 mt-2 text-sm font-medium">–ö–æ—à–µ–ª–µ–∫ –±—É–¥—É—â–µ–≥–æ</p>
            </div>
            
            <div class="space-y-3 relative z-10">
                <button id="btn-google" class="w-full h-14 bg-white text-black rounded-2xl font-bold text-sm uppercase tracking-wider flex items-center justify-center gap-3 active:scale-95 transition-all cursor-pointer">
                    <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                </button>
                <div class="flex items-center gap-4 py-2">
                    <div class="h-[1px] bg-white/10 flex-1"></div>
                    <span class="text-[10px] text-neutral-600 font-bold uppercase tracking-widest">–ò–ª–∏</span>
                    <div class="h-[1px] bg-white/10 flex-1"></div>
                </div>
                <div class="glass-panel rounded-3xl p-1.5 space-y-1.5">
                    <input type="email" id="auth-email" placeholder="Email" class="w-full bg-transparent text-white px-5 py-3.5 outline-none placeholder:text-neutral-600 font-bold">
                    <div class="h-[1px] bg-white/5 mx-5"></div>
                    <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-transparent text-white px-5 py-3.5 outline-none placeholder:text-neutral-600 font-bold">
                </div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button id="btn-login" class="h-12 glass-panel border border-white/5 text-white rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-white/10 transition-colors">–í–æ–π—Ç–∏</button>
                    <button id="btn-register" class="h-12 glass-panel border border-white/5 text-neutral-400 rounded-2xl font-black text-xs uppercase tracking-wider hover:text-white hover:bg-white/5 transition-colors">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- MAIN APP -->
        <div id="view-main" class="hidden flex-col h-full relative">
            <header class="px-6 pt-12 pb-2 flex justify-between items-center z-20 shrink-0">
                <div class="flex items-center gap-3 active:opacity-70 transition-opacity cursor-pointer" onclick="openModal('profile')">
                    <div class="p-[2px] gradient-bg rounded-full">
                        <img id="main-avatar" src="" class="w-10 h-10 rounded-full object-cover bg-black border-2 border-black">
                    </div>
                    <div class="flex flex-col justify-center">
                        <p id="main-username" class="text-xs font-bold truncate max-w-[140px] leading-tight">...</p>
                        <p class="text-[9px] font-black text-neutral-500 uppercase tracking-widest leading-tight">–ü—Ä–æ—Ñ–∏–ª—å</p>
                    </div>
                </div>
                <button id="btn-logout" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-neutral-400 hover:text-white transition-all cursor-pointer">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                </button>
            </header>

            <!-- Scrollable Content Area -->
            <main class="flex-1 overflow-y-auto px-5 hide-scroll pb-24 z-10 w-full">
                
                <!-- WALLET TAB -->
                <div id="tab-wallet" class="tab-content active space-y-6">
                    <div class="dool-card rounded-[2.5rem] p-6 relative overflow-hidden group shrink-0 mt-2">
                        <div class="absolute inset-0 gradient-bg opacity-[0.03]"></div>
                        <div class="relative z-10 flex flex-col items-center justify-center py-4">
                            <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-[0.2em] mb-2">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</span>
                            <div class="w-full flex items-baseline justify-center gap-1 mb-2">
                                <h2 id="balance-val" class="text-5xl font-black tracking-tighter">0.00</h2>
                                <span class="text-2xl font-black gradient-text">ƒê</span>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4 relative z-10">
                            <button onclick="openModal('send')" class="flex-1 h-14 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-neutral-200 active:scale-95 transition-all cursor-pointer">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            <button onclick="openModal('scan')" class="w-14 h-14 glass-panel text-white rounded-2xl flex items-center justify-center hover:bg-white/10 active:scale-95 transition-all cursor-pointer border border-white/10">
                                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg>
                            </button>
                            <button onclick="openModal('receive')" class="flex-1 h-14 glass-panel text-white border border-white/10 rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-white/10 active:scale-95 transition-all cursor-pointer">–ü–æ–ª—É—á–∏—Ç—å</button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-[11px] font-black text-neutral-500 uppercase tracking-widest px-2">–ò—Å—Ç–æ—Ä–∏—è</h3>
                        <div id="tx-history" class="space-y-2 pb-10">
                            <div class="text-center py-10"><p class="text-[10px] font-bold text-neutral-600 uppercase">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
                        </div>
                    </div>
                </div>

                <!-- INVEST TAB (NEW) -->
                <div id="tab-invest" class="tab-content space-y-6">
                    <div class="pt-2 text-center">
                        <span class="text-[9px] font-black text-[#00C9FF] uppercase tracking-widest bg-[#00C9FF]/10 px-3 py-1 rounded-full border border-[#00C9FF]/20">Live Market</span>
                    </div>

                    <!-- Market Card -->
                    <div class="dool-card rounded-[2.5rem] p-6 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-8 relative z-10">
                            <div>
                                <h2 class="text-3xl font-black text-white flex items-center gap-2">
                                    <span id="market-price">0.00</span>
                                    <span class="text-lg font-bold text-neutral-500">ƒê</span>
                                </h2>
                                <p class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest mt-1">–¶–µ–Ω–∞ DoolToken</p>
                            </div>
                            <div class="text-right">
                                <h2 class="text-xl font-black token-gradient-text flex items-center justify-end gap-1">
                                    <span id="my-stock-bal">0.0</span>
                                    <span class="text-xs">DT</span>
                                </h2>
                                <p class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest mt-1">–í–∞—à–∏ –∞–∫—Ç–∏–≤—ã</p>
                            </div>
                        </div>

                        <!-- Fake Graph SVG -->
                        <div class="h-24 w-full relative mb-4">
                            <svg viewBox="0 0 300 100" class="w-full h-full overflow-visible" preserveAspectRatio="none">
                                <defs>
                                    <linearGradient id="gradChart" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="0%" stop-color="#00C9FF" stop-opacity="0.2"/>
                                        <stop offset="100%" stop-color="#00C9FF" stop-opacity="0"/>
                                    </linearGradient>
                                </defs>
                                <path id="market-path" d="M0,80 Q30,90 60,60 T120,50 T180,70 T240,40 T300,20" class="chart-line"/>
                                <path id="market-fill" d="M0,80 Q30,90 60,60 T120,50 T180,70 T240,40 T300,20 V100 H0 Z" fill="url(#gradChart)" style="opacity: 0.5"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Trading Controls -->
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openModal('buy-stock')" class="h-24 rounded-[2rem] bg-[#00C9FF]/10 border border-[#00C9FF]/20 flex flex-col items-center justify-center gap-1 active:scale-95 transition-all">
                            <span class="text-2xl font-black text-[#00C9FF]">–ö—É–ø–∏—Ç—å</span>
                            <span class="text-[9px] font-bold text-neutral-400 uppercase">–¶–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç</span>
                        </button>
                        <button onclick="openModal('sell-stock')" class="h-24 rounded-[2rem] bg-[#FF005C]/10 border border-[#FF005C]/20 flex flex-col items-center justify-center gap-1 active:scale-95 transition-all">
                            <span class="text-2xl font-black text-[#FF005C]">–ü—Ä–æ–¥–∞—Ç—å</span>
                            <span class="text-[9px] font-bold text-neutral-400 uppercase">–¶–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç</span>
                        </button>
                    </div>

                    <div class="bg-white/5 rounded-3xl p-6 border border-white/5">
                        <h3 class="text-sm font-bold text-white mb-2">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h3>
                        <p class="text-xs text-neutral-400 leading-relaxed">
                            –≠—Ç–æ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –±–∏—Ä–∂–∞. –¶–µ–Ω–∞ <span class="text-[#00C9FF] font-bold">DoolToken</span> –º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.<br><br>
                            üü¢ –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ <b class="text-white">–ø–æ–∫—É–ø–∞–µ—Ç</b> ‚Äî —Ü–µ–Ω–∞ –∏–¥–µ—Ç –≤–≤–µ—Ä—Ö —É –≤—Å–µ—Ö.<br>
                            üî¥ –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ <b class="text-white">–ø—Ä–æ–¥–∞–µ—Ç</b> ‚Äî —Ü–µ–Ω–∞ –∏–¥–µ—Ç –≤–Ω–∏–∑ —É –≤—Å–µ—Ö.
                        </p>
                    </div>
                </div>

                <!-- REFERRAL TAB -->
                <div id="tab-referrals" class="tab-content space-y-6">
                    <div class="dool-card rounded-[2.5rem] p-6 relative overflow-hidden mt-2">
                        <div class="absolute top-0 right-0 w-32 h-32 gradient-bg blur-[60px] opacity-20"></div>
                        <h3 class="text-2xl font-black mb-2 relative z-10">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</h3>
                        <p class="text-neutral-500 text-xs mb-6 relative z-10">–ü–æ–ª—É—á–∏ <span class="text-white font-bold">10.00 ƒê</span> –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞.</p>
                        <div class="bg-black/40 border border-white/5 p-4 rounded-2xl relative z-10">
                            <input readonly id="ref-link" class="w-full text-[10px] font-mono text-neutral-400 bg-transparent outline-none truncate mb-3" value="...">
                            <div class="flex gap-2">
                                <button onclick="shareRef()" class="flex-1 h-10 flex items-center justify-center bg-white/10 text-white rounded-xl text-xs font-bold uppercase hover:bg-white/20">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                                <button onclick="copyRef()" class="w-10 h-10 flex items-center justify-center bg-white text-black rounded-xl hover:scale-105">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="dool-card p-5 rounded-[2rem] flex flex-col items-center justify-center gap-1 aspect-square">
                            <p id="ref-count" class="text-3xl font-black">0</p>
                            <p class="text-[9px] font-bold text-neutral-600 uppercase tracking-wider">–î—Ä—É–∑–µ–π</p>
                        </div>
                        <div class="dool-card p-5 rounded-[2rem] flex flex-col items-center justify-center gap-1 aspect-square">
                            <p id="ref-earned" class="text-3xl font-black">0</p>
                            <p class="text-[9px] font-bold text-neutral-600 uppercase tracking-wider">–î–æ—Ö–æ–¥</p>
                        </div>
                    </div>
                </div>

                <!-- BANK TAB -->
                <div id="tab-bank" class="tab-content space-y-6">
                    <div class="text-center pt-4 pb-2">
                        <h2 class="text-xl font-black uppercase tracking-widest text-neutral-400">–°—Ç–µ–π–∫–∏–Ω–≥</h2>
                        <p class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">+5% –≤ –Ω–µ–¥–µ–ª—é ‚åõ</p>
                    </div>
                    <div class="w-32 h-32 mx-auto relative flex items-center justify-center">
                         <img src="https://emojigraph.org/media/google/jar_1fad9.png" class="absolute z-10 w-24 brightness-[0.6] sepia-[0.2]">
                         <img src="https://emojigraph.org/media/google/fire_1f525.png" class="absolute z-20 w-12 bottom-6 opacity-0 transition-opacity duration-500 drop-shadow-[0_0_15px_#FF4D00] animate-pulse bank-fire">
                         <img src="https://emojigraph.org/media/google/jar_1fad9.png" class="absolute z-30 w-24 mix-blend-overlay opacity-40 pointer-events-none">
                    </div>
                    <div class="dool-card rounded-[2.5rem] p-6 text-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-orange-500/5"></div>
                        <p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-2 relative z-10">–í –±–∞–Ω–∫–µ</p>
                        <div class="flex items-center justify-center gap-2 relative z-10">
                            <h2 id="bank-balance-val" class="text-4xl font-black">0.0</h2>
                            <span class="text-xl font-black text-orange-500">ƒê</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openModal('deposit')" class="h-20 glass-panel rounded-[2rem] flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors border border-white/10 text-2xl">‚è∑</button>
                        <button onclick="openModal('withdraw')" class="h-20 glass-panel rounded-[2rem] flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors border border-white/10 text-2xl">‚è∂</button>
                    </div>
                </div>
            </main>

            <!-- NAVIGATION FIXED BOTTOM -->
            <nav class="absolute bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[360px] h-16 bg-[#111]/90 backdrop-blur-xl border border-white/10 rounded-[2rem] flex items-center justify-around px-2 z-50 shadow-2xl">
                <button onclick="switchTab('wallet')" id="nav-wallet" class="flex-1 h-full flex items-center justify-center text-orange-500 active:scale-90 transition-transform">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                </button>
                <button onclick="switchTab('invest')" id="nav-invest" class="flex-1 h-full flex items-center justify-center text-neutral-600 active:scale-90 transition-transform">
                     <!-- Graph Icon -->
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M3 18L9 12L13 16L21 6"/><polyline points="21 6 21 10 17 6"/></svg>
                </button>
                <button onclick="switchTab('bank')" id="nav-bank" class="flex-1 h-full flex items-center justify-center text-neutral-600 active:scale-90 transition-transform">
                     <svg width="22" height="22" viewBox="0 0 512 512" fill="currentColor"><path d="M48 480H464c17.67 0 32-14.33 32-32v-32c0-17.67-14.33-32-32-32H48c-17.67 0-32 14.33-32 32v32C16 465.7 30.33 480 48 480zM256 32c-68.39 0-127.3 40.58-154.2 99.78C100.8 134.1 102.3 136 104 136h304c1.684 0 3.238-1.896 2.227-4.219C383.3 72.58 324.4 32 256 32zM416 168c-13.25 0-24 10.75-24 24v144c0 13.25 10.75 24 24 24s24-10.75 24-24V192C440 178.8 429.3 168 416 168zM96 168c-13.25 0-24 10.75-24 24v144c0 13.25 10.75 24 24 24s24-10.75 24-24V192C120 178.8 109.3 168 96 168zM256 168c-13.25 0-24 10.75-24 24v144c0 13.25 10.75 24 24 24s24-10.75 24-24V192C280 178.8 269.3 168 256 168z"/></svg>
                </button>
                <button onclick="switchTab('referrals')" id="nav-referrals" class="flex-1 h-full flex items-center justify-center text-neutral-600 active:scale-90 transition-transform">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                </button>
            </nav>
        </div>

        <!-- MODALS -->

        <!-- Buy Stock Modal -->
        <div id="modal-buy-stock" onclick="if(event.target===this) closeModal('buy-stock')" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
            <div class="bg-[#111] border-t border-white/10 rounded-t-[2.5rem] p-0 transform translate-y-full transition-transform duration-300" id="modal-buy-stock-content">
                <div class="swipe-zone"><div class="swipe-handle"></div></div>
                <div class="p-8 pb-10">
                    <h2 class="text-xl font-black mb-4 text-[#00C9FF]">–ö—É–ø–∏—Ç—å DoolToken</h2>
                    <div class="bg-white/5 rounded-2xl p-4 border border-white/5 mb-4">
                        <p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å (ƒê)</p>
                        <div class="flex items-center gap-2">
                            <input type="number" id="buy-stock-amt" placeholder="0.0" class="w-full bg-transparent outline-none font-black text-3xl placeholder:text-neutral-700 text-white">
                            <span class="text-xl font-black gradient-text">ƒê</span>
                        </div>
                    </div>
                    <button id="btn-do-buy-stock" class="w-full h-14 bg-[#00C9FF] text-black rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-[#5cdbfd] cursor-pointer">–ö—É–ø–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Sell Stock Modal -->
        <div id="modal-sell-stock" onclick="if(event.target===this) closeModal('sell-stock')" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
            <div class="bg-[#111] border-t border-white/10 rounded-t-[2.5rem] p-0 transform translate-y-full transition-transform duration-300" id="modal-sell-stock-content">
                <div class="swipe-zone"><div class="swipe-handle"></div></div>
                <div class="p-8 pb-10">
                    <h2 class="text-xl font-black mb-4 text-[#FF005C]">–ü—Ä–æ–¥–∞—Ç—å DoolToken</h2>
                    <div class="bg-white/5 rounded-2xl p-4 border border-white/5 mb-4">
                        <p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (DT)</p>
                        <div class="flex items-center gap-2">
                            <input type="number" id="sell-stock-amt" placeholder="0.0" class="w-full bg-transparent outline-none font-black text-3xl placeholder:text-neutral-700 text-white">
                            <span class="text-xl font-black token-gradient-text">DT</span>
                        </div>
                    </div>
                    <button id="btn-do-sell-stock" class="w-full h-14 bg-[#FF005C] text-white rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-[#ff4286] cursor-pointer">–ü—Ä–æ–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Other Modals (Preserved) -->
        <div id="modal-profile" onclick="if(event.target===this) closeModal('profile')" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-8 opacity-0 transition-opacity duration-300">
            <div class="w-full max-w-xs transform scale-90 transition-transform duration-300" id="modal-profile-content">
                <div class="bg-[#111] border border-white/10 p-8 rounded-[2.5rem] text-center">
                    <h2 class="text-xl font-black mb-6">–ü—Ä–æ—Ñ–∏–ª—å</h2>
                    <div class="relative inline-block mb-6"><div class="p-1 gradient-bg rounded-full"><img id="edit-avatar-img" src="" class="w-24 h-24 rounded-full object-cover border-4 border-[#111]"></div><label class="absolute bottom-0 right-0 bg-white text-black w-8 h-8 flex items-center justify-center rounded-full cursor-pointer"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg><input type="file" id="avatar-input" class="hidden" accept="image/*"></label></div>
                    <p id="profile-email" class="text-xs text-neutral-500 font-bold mb-6 truncate px-2">...</p>
                    <button onclick="closeModal('profile')" class="w-full h-12 bg-white/5 border border-white/10 text-white rounded-xl font-bold text-xs uppercase">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="modal-invited-info" onclick="if(event.target===this) closeModal('invited-info')" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-8 opacity-0 transition-opacity duration-300">
            <div class="w-full max-w-xs transform scale-90 transition-transform duration-300" id="modal-invited-info-content">
                <div class="bg-[#111] border border-orange-500/30 p-8 rounded-[2.5rem] text-center">
                    <div class="w-16 h-16 bg-orange-500/10 rounded-full flex items-center justify-center text-4xl mx-auto mb-4">üéÅ</div>
                    <h2 class="text-xl font-black mb-2">–ë–æ–Ω—É—Å!</h2>
                    <p class="text-xs text-neutral-400 font-medium mb-6">–û—Ç: <span id="invited-by-email" class="text-orange-500 font-bold">...</span></p>
                    <div class="bg-white/5 rounded-2xl p-4 mb-6"><p class="text-2xl font-black text-white">+10.00 ƒê</p></div>
                    <button onclick="closeModal('invited-info')" class="w-full h-12 bg-white text-black rounded-xl font-bold text-xs uppercase">–û—Ç–ª–∏—á–Ω–æ</button>
                </div>
            </div>
        </div>

        <div id="modal-send" onclick="if(event.target===this) closeModal('send')" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
            <div class="bg-[#0f0f0f] border-t border-white/10 rounded-t-[2.5rem] p-0 transform translate-y-full transition-transform duration-300" id="modal-send-content">
                <div class="swipe-zone"><div class="swipe-handle"></div></div>
                <div class="p-8 pb-10">
                    <h2 class="text-2xl font-black mb-6">–ü–µ—Ä–µ–≤–æ–¥</h2>
                    <div id="proposal-notice" class="hidden mb-4 bg-orange-500/10 border border-orange-500/20 p-3 rounded-2xl flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-black"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg></div><div><p class="text-[10px] font-black uppercase text-orange-500">–ê–≤—Ç–æ</p></div></div>
                    <div class="space-y-3">
                        <div class="bg-white/5 rounded-2xl p-4 border border-white/5"><p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">Email</p><input type="email" id="send-email" class="w-full bg-transparent outline-none font-bold text-sm"></div>
                        <div class="bg-white/5 rounded-2xl p-4 border border-white/5"><p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–°—É–º–º–∞</p><div class="flex items-center gap-2"><input type="number" id="send-amt" class="w-full bg-transparent outline-none font-black text-3xl"><span class="text-xl font-black text-orange-500">ƒê</span></div></div>
                        <button id="btn-do-send" class="w-full h-14 bg-white text-black rounded-2xl font-black text-xs uppercase mt-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-receive" onclick="if(event.target===this) closeModal('receive')" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
            <div class="bg-[#0f0f0f] border border-white/10 rounded-t-[2.5rem] p-0 w-full transform translate-y-full transition-transform duration-300" id="modal-receive-content">
                <div class="swipe-zone"><div class="swipe-handle"></div></div>
                <div class="p-8 pb-10">
                    <div class="text-center mb-6"><h2 class="text-2xl font-black mb-1">–ü–æ–ª—É—á–∏—Ç—å</h2><p class="text-neutral-500 text-xs">–ü–æ–∫–∞–∂–∏—Ç–µ QR –∫–æ–¥</p></div>
                    <div class="flex justify-center mb-8"><div class="bg-white p-4 rounded-xl" id="qrcode-container"></div></div>
                    <div class="space-y-4">
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/5 flex items-center justify-between"><div class="flex-1"><p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–°—É–º–º–∞ (–û–ø—Ü–∏—è)</p><input type="number" id="receive-amt-req" placeholder="-" class="w-full bg-transparent outline-none font-bold text-lg"></div><span class="text-lg font-black text-orange-500 ml-3">ƒê</span></div>
                        <div onclick="copyMyEmail()" class="bg-white/5 p-4 rounded-2xl flex items-center justify-between cursor-pointer border border-white/5"><div class="flex-1 min-w-0 pr-2"><p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–í–∞—à –∞–¥—Ä–µ—Å</p><p id="my-email-addr" class="font-mono text-orange-500 truncate text-sm">...</p></div><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-deposit" onclick="if(event.target===this) closeModal('deposit')" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
            <div class="bg-[#111] border-t border-white/10 rounded-t-[2.5rem] p-0 transform translate-y-full transition-transform duration-300" id="modal-deposit-content">
                <div class="swipe-zone"><div class="swipe-handle"></div></div>
                <div class="p-8 pb-10">
                    <h2 class="text-xl font-black mb-4">–í –±–∞–Ω–∫—É</h2>
                    <div class="bg-white/5 rounded-2xl p-4 border border-white/5 mb-4"><p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–°—É–º–º–∞</p><div class="flex items-center gap-2"><input type="number" id="deposit-amt" class="w-full bg-transparent outline-none font-black text-3xl"><span class="text-xl font-black text-orange-500">ƒê</span></div></div>
                    <button id="btn-do-deposit" class="w-full h-14 bg-white text-black rounded-2xl font-black text-xs uppercase">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="modal-withdraw" onclick="if(event.target===this) closeModal('withdraw')" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
             <div class="bg-[#111] border-t border-white/10 rounded-t-[2.5rem] p-0 transform translate-y-full transition-transform duration-300" id="modal-withdraw-content">
                <div class="swipe-zone"><div class="swipe-handle"></div></div>
                <div class="p-8 pb-10">
                    <h2 class="text-xl font-black mb-4">–ò–∑ –±–∞–Ω–∫–∏</h2>
                    <div class="bg-white/5 rounded-2xl p-4 border border-white/5 mb-4"><p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–°—É–º–º–∞</p><div class="flex items-center gap-2"><input type="number" id="withdraw-amt" class="w-full bg-transparent outline-none font-black text-3xl"><span class="text-xl font-black text-orange-500">ƒê</span></div></div>
                    <button id="btn-do-withdraw" class="w-full h-14 bg-white text-black rounded-2xl font-black text-xs uppercase">–î–æ—Å—Ç–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="modal-scan" class="hidden absolute inset-0 z-[120] bg-black flex flex-col opacity-0 transition-opacity duration-300">
            <div class="absolute top-0 left-0 w-full p-6 z-20 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent">
                 <h2 class="text-xl font-black text-white">–°–∫–∞–Ω</h2>
                 <button onclick="closeModal('scan')" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-white"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            </div>
            <div class="w-full h-full relative" id="modal-scan-content">
                <div id="reader"></div>
                <div class="scan-focus-area"><div class="scan-laser"></div></div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, runTransaction, Timestamp, increment, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBoFuGY-SSmcGHPGzuWZbdGFeI9_aaAKs8",
          authDomain: "doolcoinwallet.firebaseapp.com",
          projectId: "doolcoinwallet",
          storageBucket: "doolcoinwallet.firebasestorage.app",
          messagingSenderId: "473549726148",
          appId: "1:473549726148:web:87663b4944330c0df58491"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let myData = null;
        let lastBal = null;
        let currentMarketPrice = 10.0; // Default fallback
        let html5QrCode = null; 
        
        // --- SWIPE LOGIC ---
        function initSwipeClose(modalName) {
            const m = document.getElementById('modal-'+modalName);
            const c = document.getElementById(`modal-${modalName}-content`);
            if(!c) return;
            const h = c.querySelector('.swipe-zone');
            if(!h) return;
            let startY = 0, currentY = 0, isDrag = false;
            h.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; isDrag = true; c.style.transition='none'; }, {passive:true});
            h.addEventListener('touchmove', (e) => { if(!isDrag)return; currentY=e.touches[0].clientY; const diff=currentY-startY; if(diff>0) c.style.transform=`translateY(${diff}px)`; }, {passive:true});
            h.addEventListener('touchend', () => { isDrag=false; c.style.transition='transform 0.3s cubic-bezier(0.34,1.56,0.64,1)'; if((currentY-startY)>120) closeModal(modalName); else c.style.transform=''; });
        }
        ['send','receive','deposit','withdraw','buy-stock','sell-stock'].forEach(initSwipeClose);

        // --- CORE FUNCTIONS ---
        window.openModal = (n) => {
            const m=document.getElementById('modal-'+n), c=document.getElementById(`modal-${n}-content`);
            if(!m)return;
            m.classList.remove('hidden'); void m.offsetWidth; m.classList.remove('opacity-0');
            if(c) { c.style.transform=''; setTimeout(()=>c.classList.remove('translate-y-full'),10); }
            else if(n!=='scan') document.getElementById(`modal-${n}-content`).classList.remove('scale-90');
            if(n==='receive') updateQR();
            if(n==='scan') startScannerV2();
        };

        window.closeModal = (n) => {
            const m=document.getElementById('modal-'+n), c=document.getElementById(`modal-${n}-content`);
            if(!m)return;
            m.classList.add('opacity-0');
            if(c) { c.classList.add('translate-y-full'); c.style.transform=''; }
            else if(n!=='scan') document.getElementById(`modal-${n}-content`).classList.add('scale-90');
            if(n==='scan') stopScannerV2();
            if(n==='send') setTimeout(()=>{ document.getElementById('send-amt').value=''; document.getElementById('send-email').value=''; document.getElementById('proposal-notice').classList.add('hidden'); },300);
            setTimeout(()=>m.classList.add('hidden'),300);
        };

        let toastTimer;
        window.showT = (title, msg, amt='', sender=null, err=false) => {
            const t=document.getElementById('toast'), i=document.getElementById('toast-icon-sys'), a=document.getElementById('toast-avatar');
            clearTimeout(toastTimer); t.classList.remove('active');
            setTimeout(async()=>{
                document.getElementById('toast-title').textContent=title;
                document.getElementById('toast-msg').textContent=msg;
                document.getElementById('toast-amount').textContent=amt;
                document.getElementById('toast-amount').classList.toggle('hidden',!amt);
                a.className="w-full h-full hidden"; i.classList.add('hidden');
                if(sender) {
                    a.classList.remove('hidden'); a.classList.add('object-cover');
                    a.src=`https://ui-avatars.com/api/?background=random&color=fff&name=${sender.charAt(0)}`;
                } else {
                    const icon = err ? "‚ö†Ô∏è" : (title.includes('–ë–∞–Ω–∫') ? "üçØ" : "üîî");
                    i.classList.remove('hidden'); i.textContent=icon;
                }
                t.classList.add('active');
                toastTimer=setTimeout(()=>t.classList.remove('active'),4000);
            },100);
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => {
                 b.className = b.id === 'nav-'+tab ? "flex-1 h-full flex items-center justify-center text-orange-500 active:scale-90 transition-transform" : "flex-1 h-full flex items-center justify-center text-neutral-600 active:scale-90 transition-transform";
                 if(tab === 'invest' && b.id === 'nav-invest') b.classList.replace('text-orange-500', 'text-[#00C9FF]');
            });
        };

        // --- AUTH & DATA ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                const userRef = doc(db, "users", u.uid);
                const snap = await getDoc(userRef);
                if (!snap.exists()) {
                    await setDoc(userRef, {
                        email: u.email, lowercaseEmail: u.email.toLowerCase(),
                        balance: 10.0, bankBalance: 0, stockBalance: 0,
                        lastBankUpdate: Timestamp.now(), avatar: u.photoURL || '',
                        refCount: 0, refEarned: 0, createdAt: Timestamp.now()
                    });
                    // Check Referral
                    const refEmail = localStorage.getItem('dool_ref');
                    if (refEmail && refEmail !== u.email.toLowerCase()) {
                        const q = query(collection(db, "users"), where("lowercaseEmail", "==", refEmail));
                        const rSnap = await getDocs(q);
                        if(!rSnap.empty) {
                            await runTransaction(db, async(t) => {
                                t.update(rSnap.docs[0].ref, { balance: increment(10), refCount: increment(1), refEarned: increment(10) });
                                t.set(doc(collection(db, "transactions")), { from: 'System', to: rSnap.docs[0].data().email, amount: 10, date: Timestamp.now(), parties: [rSnap.docs[0].data().email], type:'ref' });
                            });
                        }
                    }
                }
                startApp(u);
            } else {
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('view-main').classList.add('hidden');
                document.getElementById('view-auth').classList.replace('hidden', 'flex');
            }
        });

        // --- MARKET LOGIC (INVESTMENTS) ---
        function initMarketListener() {
            const marketRef = doc(db, "market", "dool_token");
            onSnapshot(marketRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentMarketPrice = data.price;
                    document.getElementById('market-price').textContent = data.price.toFixed(2);
                    
                    // Simple Chart Visualizer logic (Just randomized path based on price trend)
                    const p = data.price;
                    const h = 100; // viewbox height
                    // Map price 0-50 to y 100-0 roughly
                    const y = Math.max(10, Math.min(90, 100 - (p * 2))); 
                    const path = `M0,80 Q50,${y+10} 100,${y-5} T150,${y} T200,${y+5} T300,${y}`;
                    document.getElementById('market-path').setAttribute('d', path);
                    document.getElementById('market-fill').setAttribute('d', path + ' V100 H0 Z');
                } else {
                    // Init market if doesn't exist
                    setDoc(marketRef, { price: 10.0, volume: 0 });
                }
            });
        }

        // Buy Stock
        document.getElementById('btn-do-buy-stock').onclick = async () => {
            const spend = parseFloat(document.getElementById('buy-stock-amt').value);
            if (!spend || spend < 1) return showT('–û—à–∏–±–∫–∞', '–ú–∏–Ω–∏–º—É–º 1 ƒê', '', null, true);
            if (spend > myData.balance) return showT('–û—à–∏–±–∫–∞', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', '', null, true);

            const btn = document.getElementById('btn-do-buy-stock');
            btn.disabled = true; btn.textContent = "...";

            try {
                await runTransaction(db, async (t) => {
                    const uRef = doc(db, "users", auth.currentUser.uid);
                    const mRef = doc(db, "market", "dool_token");
                    
                    const uDoc = await t.get(uRef);
                    const mDoc = await t.get(mRef);
                    
                    if (!mDoc.exists()) throw "Market error";
                    
                    const curPrice = mDoc.data().price;
                    const tokensToGet = spend / curPrice;
                    const newBal = uDoc.data().balance - spend;
                    const newStock = (uDoc.data().stockBalance || 0) + tokensToGet;
                    
                    // Price Impact: Buy increases price slightly (0.01 per 10 coins spent)
                    const priceImpact = (spend / 100) * 0.1; 
                    const newPrice = curPrice + priceImpact;

                    t.update(uRef, { balance: newBal, stockBalance: newStock });
                    t.update(mRef, { price: newPrice, volume: increment(spend) });
                });
                closeModal('buy-stock');
                document.getElementById('buy-stock-amt').value = '';
                showT('–ë–∏—Ä–∂–∞', '–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞', `+${(spend/currentMarketPrice).toFixed(2)} DT`);
            } catch (e) { showT('–û—à–∏–±–∫–∞', e.message || e, '', null, true); }
            finally { btn.disabled = false; btn.textContent = "–ö—É–ø–∏—Ç—å"; }
        };

        // Sell Stock
        document.getElementById('btn-do-sell-stock').onclick = async () => {
            const amount = parseFloat(document.getElementById('sell-stock-amt').value);
            if (!amount || amount <= 0) return showT('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', '', null, true);
            if (amount > (myData.stockBalance || 0)) return showT('–û—à–∏–±–∫–∞', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤', '', null, true);

            const btn = document.getElementById('btn-do-sell-stock');
            btn.disabled = true; btn.textContent = "...";

            try {
                await runTransaction(db, async (t) => {
                    const uRef = doc(db, "users", auth.currentUser.uid);
                    const mRef = doc(db, "market", "dool_token");
                    
                    const uDoc = await t.get(uRef);
                    const mDoc = await t.get(mRef);
                    
                    const curPrice = mDoc.data().price;
                    const receive = amount * curPrice;
                    
                    const newBal = uDoc.data().balance + receive;
                    const newStock = uDoc.data().stockBalance - amount;

                    // Price Impact: Sell decreases price
                    const priceImpact = (receive / 100) * 0.1;
                    let newPrice = curPrice - priceImpact;
                    if(newPrice < 0.1) newPrice = 0.1; // Floor price

                    t.update(uRef, { balance: newBal, stockBalance: newStock });
                    t.update(mRef, { price: newPrice, volume: increment(receive) });
                });
                closeModal('sell-stock');
                document.getElementById('sell-stock-amt').value = '';
                showT('–ë–∏—Ä–∂–∞', '–ü—Ä–æ–¥–∞–∂–∞ —É—Å–ø–µ—à–Ω–∞', `+${(amount * currentMarketPrice).toFixed(1)} ƒê`);
            } catch (e) { showT('–û—à–∏–±–∫–∞', e.message || e, '', null, true); }
            finally { btn.disabled = false; btn.textContent = "–ü—Ä–æ–¥–∞—Ç—å"; }
        };

        function startApp(u) {
            document.getElementById('main-username').textContent = u.email;
            document.getElementById('profile-email').textContent = u.email;
            document.getElementById('my-email-addr').textContent = u.email;
            document.getElementById('ref-link').value = window.location.href.split('?')[0] + '?ref=' + u.email;

            // Init Market
            initMarketListener();

            onSnapshot(doc(db, "users", u.uid), (snap) => {
                const d = snap.data();
                if (!d) return;
                myData = d;
                
                // Wallet Update
                if (lastBal !== null && d.balance > lastBal) {
                    const diff = d.balance - lastBal;
                    if(diff > 0.01) showT('–ë–∞–ª–∞–Ω—Å', '–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤', `+${diff.toFixed(2)} ƒê`);
                }
                lastBal = d.balance;
                document.getElementById('balance-val').textContent = d.balance.toFixed(2);
                
                // Stock Update
                document.getElementById('my-stock-bal').textContent = (d.stockBalance || 0).toFixed(2);
                
                // Bank Update
                updateBankVisuals(d);
                
                // Refs
                document.getElementById('ref-count').textContent = d.refCount || 0;
                document.getElementById('ref-earned').textContent = (d.refEarned || 0).toFixed(1);

                // Avatar
                const av = d.avatar || `https://ui-avatars.com/api/?background=random&color=fff&name=${u.email.charAt(0)}`;
                document.getElementById('main-avatar').src = av;
                document.getElementById('edit-avatar-img').src = av;

                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('view-main').classList.replace('hidden', 'flex');
            });

            // TX History
            const qTx = query(collection(db, "transactions"), where("parties", "array-contains", u.email));
            onSnapshot(qTx, (snap) => {
                const list = document.getElementById('tx-history');
                if (snap.empty) { list.innerHTML = '<p class="text-center text-neutral-600 text-[10px] uppercase font-bold py-4">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>'; return; }
                const docs = snap.docs.map(d => d.data()).sort((a,b) => b.date - a.date);
                let html = '';
                docs.forEach(tx => {
                    const isSent = tx.from === u.email;
                    const partner = isSent ? tx.to : tx.from;
                    const sys = partner === 'System' || partner === 'System (Ref)';
                    html += `<div class="flex items-center justify-between p-4 rounded-[1.5rem] bg-white/[0.03] border border-white/5">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-full bg-neutral-800 flex items-center justify-center border border-white/5 shrink-0 text-lg">${sys ? 'ü§ñ' : 'üë§'}</div>
                            <div class="min-w-0"><p class="text-[9px] font-black uppercase ${isSent ? 'text-neutral-500' : 'text-[#FF4D00]'} tracking-widest mb-0.5">${isSent ? '–ö–æ–º—É:' : '–û—Ç:'}</p><p class="text-[11px] font-bold text-white truncate w-32">${partner}</p></div>
                        </div>
                        <div class="text-right"><p class="text-sm font-black ${isSent ? 'text-white' : 'text-[#FF4D00]'}">${isSent ? '-' : '+'}${tx.amount.toFixed(1)}</p></div>
                    </div>`;
                });
                list.innerHTML = html;
            });
        }

        // --- BANK LOGIC ---
        function updateBankVisuals(d) {
            const stored = d.bankBalance || 0;
            if(stored <= 0) { document.getElementById('bank-balance-val').textContent = "0.0"; return; }
            const diffWeeks = (new Date() - d.lastBankUpdate.toDate()) / (1000 * 60 * 60 * 24 * 7);
            const compound = stored * Math.pow(1.05, diffWeeks);
            document.getElementById('bank-balance-val').textContent = compound.toFixed(2);
            const fire = document.querySelector('.bank-fire');
            if(fire) fire.style.opacity = compound > 0.1 ? '1' : '0';
        }

        document.getElementById('btn-do-deposit').onclick = async () => {
            const amt = parseFloat(document.getElementById('deposit-amt').value);
            if (!amt || amt < 0.1) return showT('–û—à–∏–±–∫–∞', '–ú–∏–Ω 0.1', '', null, true);
            if (amt > myData.balance) return;
            try {
                await runTransaction(db, async(t) => {
                    const r = doc(db, "users", auth.currentUser.uid);
                    const d = (await t.get(r)).data();
                    const nowBal = d.bankBalance * Math.pow(1.05, (new Date() - d.lastBankUpdate.toDate()) / (604800000));
                    t.update(r, { balance: d.balance - amt, bankBalance: nowBal + amt, lastBankUpdate: serverTimestamp() });
                });
                closeModal('deposit'); showT('–ë–∞–Ω–∫', '–î–µ–ø–æ–∑–∏—Ç —É—Å–ø–µ—à–µ–Ω');
            } catch(e) { showT('–û—à–∏–±–∫–∞', '–°–±–æ–π', '', null, true); }
        };

        document.getElementById('btn-do-withdraw').onclick = async () => {
             const amt = parseFloat(document.getElementById('withdraw-amt').value);
             if (!amt) return;
             try {
                await runTransaction(db, async(t) => {
                    const r = doc(db, "users", auth.currentUser.uid);
                    const d = (await t.get(r)).data();
                    const nowBal = d.bankBalance * Math.pow(1.05, (new Date() - d.lastBankUpdate.toDate()) / (604800000));
                    if(amt > nowBal) throw "Low funds";
                    t.update(r, { balance: d.balance + amt, bankBalance: nowBal - amt, lastBankUpdate: serverTimestamp() });
                });
                closeModal('withdraw'); showT('–ë–∞–Ω–∫', '–í—ã–≤–æ–¥ —É—Å–ø–µ—à–µ–Ω');
            } catch(e) { showT('–û—à–∏–±–∫–∞', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤ –±–∞–Ω–∫–µ', '', null, true); }
        };

        // --- MISC HANDLERS ---
        document.getElementById('btn-login').onclick = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); } catch(e) { showT('–û—à–∏–±–∫–∞', '–í—Ö–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω', '', null, true); } };
        document.getElementById('btn-register').onclick = async () => { try { await createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); } catch(e) { showT('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', '', null, true); } };
        document.getElementById('btn-google').onclick = async () => { try { await signInWithPopup(auth, googleProvider); } catch(e) { console.log(e); } };
        document.getElementById('btn-logout').onclick = () => signOut(auth);
        
        window.updateQR = () => {
            const c=document.getElementById('qrcode-container'); c.innerHTML='';
            new QRCode(c, { text: JSON.stringify({t:"req",e:auth.currentUser.email,a:document.getElementById('receive-amt-req').value||0}), width:180, height:180 });
        };
        
        window.startScannerV2 = () => {
             if(html5QrCode) return;
             html5QrCode = new Html5Qrcode("reader");
             html5QrCode.start({ facingMode: "environment" }, { fps: 10 }, (txt) => {
                 closeModal('scan');
                 try { const d = JSON.parse(txt); if(d.e) { openModal('send'); document.getElementById('send-email').value=d.e; if(d.a>0) document.getElementById('send-amt').value=d.a; } } 
                 catch { if(txt.includes('@')) { openModal('send'); document.getElementById('send-email').value=txt; } }
             }, ()=>{});
        };
        window.stopScannerV2 = () => { if(html5QrCode) { html5QrCode.stop().then(()=>{html5QrCode.clear();html5QrCode=null;}); } };
        
        document.getElementById('btn-do-send').onclick = async () => {
            const to = document.getElementById('send-email').value.toLowerCase(), amt = parseFloat(document.getElementById('send-amt').value);
            if(!to || !amt) return;
            try {
                const q = query(collection(db, "users"), where("email", "==", to));
                const snap = await getDocs(q);
                if(snap.empty) throw "User not found";
                await runTransaction(db, async(t)=>{
                    const sRef = doc(db,"users",auth.currentUser.uid);
                    const sDoc = await t.get(sRef);
                    if(sDoc.data().balance < amt) throw "Low balance";
                    t.update(sRef, {balance: increment(-amt)});
                    t.update(snap.docs[0].ref, {balance: increment(amt)});
                    t.set(doc(collection(db,"transactions")), {from:auth.currentUser.email, to:to, amount:amt, date:Timestamp.now(), parties:[auth.currentUser.email, to]});
                });
                closeModal('send'); showT('–£—Å–ø–µ—à–Ω–æ', `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${to}`, `-${amt} ƒê`);
            } catch(e) { showT('–û—à–∏–±–∫–∞', '–°–±–æ–π –ø–µ—Ä–µ–≤–æ–¥–∞', '', null, true); }
        };
        
        window.copyRef = () => { navigator.clipboard.writeText(document.getElementById('ref-link').value); showT('–£—Å–ø–µ—à–Ω–æ', '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); };
        window.shareRef = () => { try{navigator.share({url:document.getElementById('ref-link').value});}catch{copyRef();} };
        window.copyMyEmail = () => { navigator.clipboard.writeText(auth.currentUser.email); showT('–£—Å–ø–µ—à–Ω–æ', 'Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); };
    </script>
</body>
</html>