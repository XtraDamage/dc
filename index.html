<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doolcoin Wallet 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base & Reset */
        * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        input { -webkit-user-select: text !important; user-select: text !important; }
        body { background-color: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
        
        /* Design System */
        .gradient-text { background: linear-gradient(135deg, #FF4D00, #FF005C); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gradient-bg { background: linear-gradient(135deg, #FF4D00, #FF005C); }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .dool-card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.05); }
        
        /* Animations */
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        
        #toast { transform: translateY(-150%) scale(0.9); transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); opacity: 0; }
        #toast.active { transform: translateY(0) scale(1); opacity: 1; }

        /* Chart */
        .chart-line { fill: none; stroke: #FF4D00; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .chart-area { fill: url(#chartGradient); opacity: 0.2; }

        /* Scanner */
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; }
        .scan-focus-area {
            position: absolute; top: 50%; left: 50%; width: 260px; height: 260px;
            transform: translate(-50%, -50%); box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85);
            border-radius: 2rem; pointer-events: none; z-index: 10;
        }
        .scan-laser {
            position: absolute; width: 100%; height: 2px; top: 50%;
            background: #FF4D00; box-shadow: 0 0 10px #FF4D00;
            animation: scanAnim 2s infinite ease-in-out;
        }
        @keyframes scanAnim { 0%, 100% { opacity: 0; transform: translateY(-100px); } 50% { opacity: 1; transform: translateY(100px); } }

        /* Jar Animation */
        .jar-liquid { transition: height 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .coin-fall { animation: coinDrop 0.6s cubic-bezier(0.5, 0.05, 1, 0.5); }
        @keyframes coinDrop { from { transform: translateY(-100px) rotate(0deg); opacity: 0; } to { transform: translateY(0) rotate(360deg); opacity: 1; } }
        
        /* Toggles */
        .toggle-checkbox:checked { right: 0; border-color: #FF4D00; }
        .toggle-checkbox:checked + .toggle-label { background-color: #FF4D00; }
    </style>
</head>
<body>

    <div id="app" class="max-w-[480px] mx-auto h-[100dvh] flex flex-col relative bg-black shadow-2xl overflow-hidden">
        
        <!-- Toast Notification -->
        <div id="toast" class="fixed top-4 left-4 right-4 z-[200] glass-panel p-3 rounded-[2rem] flex items-center gap-3 shadow-2xl pointer-events-none border border-white/10">
            <div class="relative shrink-0">
                <img id="toast-avatar" src="" class="w-12 h-12 rounded-full object-cover bg-neutral-800 border-2 border-white/10">
                <div id="toast-status" class="absolute -bottom-1 -right-1 bg-green-500 w-4 h-4 rounded-full border-2 border-black flex items-center justify-center">
                    <svg width="8" height="8" viewBox="0 0 24 24" stroke="black" stroke-width="3" fill="none"><path d="M20 6L9 17l-5-5"/></svg>
                </div>
            </div>
            <div class="flex-1 min-w-0 pr-2">
                <p id="toast-title" class="text-[10px] font-black uppercase text-neutral-400 tracking-widest mb-0.5">–°–∏—Å—Ç–µ–º–∞</p>
                <div class="flex items-center justify-between">
                    <p id="toast-msg" class="text-xs font-bold text-white truncate mr-2">–°–æ–æ–±—â–µ–Ω–∏–µ</p>
                    <p id="toast-amount" class="text-sm font-black text-[#FF4D00] whitespace-nowrap hidden"></p>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="view-loading" class="absolute inset-0 z-[100] bg-black flex items-center justify-center">
            <div class="relative">
                <div class="w-32 h-32 gradient-bg rounded-full blur-[50px] opacity-30 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 animate-pulse"></div>
                <span class="text-8xl font-black gradient-text relative z-10">ƒê</span>
            </div>
        </div>

        <!-- Auth Screen -->
        <div id="view-auth" class="hidden flex-col h-full p-8 justify-center relative">
            <div class="absolute top-0 left-0 w-full h-1/2 gradient-bg opacity-[0.05] blur-3xl pointer-events-none"></div>
            
            <!-- Referral Gift Button (Floating) -->
            <button id="btn-ref-gift" onclick="openModal('ref-info')" class="hidden absolute top-8 right-6 w-12 h-12 bg-[#FF4D00] rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(255,77,0,0.4)] z-50 hover:scale-110 transition-transform cursor-pointer animate-bounce">
                <span class="text-2xl">üéÅ</span>
            </button>

            <div class="text-center mb-12 relative z-10">
                <span class="text-8xl font-black gradient-text inline-block mb-4">ƒê</span>
                <h1 class="text-4xl font-extrabold tracking-tight">Doolcoin</h1>
                <p class="text-neutral-500 mt-2 text-sm font-medium">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–±–æ–¥–∞</p>
            </div>
            
            <div class="space-y-4 relative z-10">
                <button id="btn-google" class="w-full h-16 bg-white text-black rounded-2xl font-bold text-sm uppercase tracking-wider flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84.81-.81z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                </button>

                <div class="glass-panel rounded-3xl p-1.5 space-y-1.5">
                    <input type="email" id="auth-email" placeholder="Email" class="w-full bg-transparent text-white px-5 py-4 outline-none placeholder:text-neutral-600 font-bold">
                    <div class="h-[1px] bg-white/5 mx-5"></div>
                    <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-transparent text-white px-5 py-4 outline-none placeholder:text-neutral-600 font-bold">
                </div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button id="btn-login" class="h-14 glass-panel border border-white/5 text-white rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-white/10">–í–æ–π—Ç–∏</button>
                    <button id="btn-register" class="h-14 glass-panel border border-white/5 text-neutral-400 rounded-2xl font-black text-xs uppercase tracking-wider hover:text-white">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Main App Interface -->
        <div id="view-main" class="hidden flex flex-col h-full">
            <header class="px-6 pt-14 pb-4 flex justify-between items-center z-20">
                <div class="flex items-center gap-3">
                    <div class="p-[2px] gradient-bg rounded-full shadow-[0_0_15px_rgba(255,77,0,0.3)]">
                        <img id="main-avatar" src="" class="w-10 h-10 rounded-full object-cover bg-black border-2 border-black">
                    </div>
                    <div>
                        <p id="main-username" class="text-xs font-bold truncate max-w-[140px] leading-tight text-white">...</p>
                        <p class="text-[9px] font-black text-[#FF4D00] uppercase tracking-widest leading-tight">Pro Account</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openModal('scan')" class="w-10 h-10 glass-panel rounded-full flex items-center justify-center text-white hover:bg-white/10 active:scale-95 transition-all">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto px-5 hide-scroll pb-32 z-10 relative">
                
                <!-- Tab: Wallet -->
                <div id="tab-wallet" class="tab-content active space-y-6">
                    <div class="dool-card rounded-[2.5rem] p-8 relative overflow-hidden group">
                        <div class="absolute -right-12 -top-12 w-48 h-48 bg-[#FF4D00] rounded-full blur-[80px] opacity-20 group-hover:opacity-30 transition-opacity"></div>
                        <div class="relative z-10 text-center py-4">
                            <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-[0.2em]">–ë–∞–ª–∞–Ω—Å</span>
                            <div class="flex items-baseline justify-center gap-1 mt-2">
                                <h2 id="balance-val" class="text-5xl font-black tracking-tighter">0.00</h2>
                                <span class="text-2xl font-black gradient-text">ƒê</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-6 relative z-10">
                            <button onclick="openModal('send')" class="h-14 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-neutral-200 active:scale-95 transition-all shadow-lg shadow-white/5">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            <button onclick="openModal('receive')" class="h-14 glass-panel text-white border border-white/10 rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-white/10 active:scale-95 transition-all">–ü–æ–ª—É—á–∏—Ç—å</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black text-neutral-500 uppercase tracking-widest mb-3 px-2">–ò—Å—Ç–æ—Ä–∏—è</h3>
                        <div id="tx-history" class="space-y-2 pb-10">
                            <!-- JS populates this -->
                        </div>
                    </div>
                </div>

                <!-- Tab: Invest (Beta & Jar) -->
                <div id="tab-invest" class="tab-content space-y-6">
                    <!-- Market Card -->
                    <div class="dool-card rounded-[2.5rem] p-6 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-2xl font-black flex items-center gap-2">Beta <span class="text-[#FF4D00] text-sm bg-[#FF4D00]/10 px-2 py-0.5 rounded-md">Œ≤</span></h3>
                                <p class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">–¶–µ–Ω–∞ —Ç–æ–∫–µ–Ω–∞</p>
                            </div>
                            <div class="text-right">
                                <p id="beta-price" class="text-2xl font-black text-white">0.00 ƒê</p>
                                <p id="beta-change" class="text-[10px] font-bold text-green-500">Live Market</p>
                            </div>
                        </div>

                        <!-- Chart Area -->
                        <div class="h-32 w-full mb-4 bg-white/[0.02] rounded-xl overflow-hidden relative">
                             <svg id="beta-chart" class="w-full h-full" preserveAspectRatio="none">
                                 <defs>
                                     <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                                         <stop offset="0%" stop-color="#FF4D00"/>
                                         <stop offset="100%" stop-color="#FF4D00" stop-opacity="0"/>
                                     </linearGradient>
                                 </defs>
                                 <path id="chart-area-path" class="chart-area" d="" />
                                 <path id="chart-line-path" class="chart-line" d="" />
                             </svg>
                        </div>

                        <div class="bg-white/5 rounded-xl p-3 flex justify-between items-center mb-4">
                            <span class="text-[10px] uppercase font-bold text-neutral-500">–í–∞—à –ø–æ—Ä—Ç—Ñ–µ–ª—å</span>
                            <span class="font-black"><span id="my-beta-bal">0.00</span> Œ≤</span>
                        </div>

                        <div class="grid grid-cols-2 gap-3 relative z-10">
                            <button onclick="openModal('trade-buy')" class="h-12 bg-[#FF4D00] text-white rounded-xl font-black text-xs uppercase tracking-wider active:scale-95 transition-transform">–ö—É–ø–∏—Ç—å</button>
                            <button onclick="openModal('trade-sell')" class="h-12 glass-panel border border-white/10 text-white rounded-xl font-black text-xs uppercase tracking-wider active:scale-95 transition-transform">–ü—Ä–æ–¥–∞—Ç—å</button>
                        </div>
                    </div>

                    <!-- The Glass Jar (Staking) -->
                    <div class="dool-card rounded-[2.5rem] p-6 flex flex-col items-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-full h-full bg-gradient-to-b from-blue-500/5 to-transparent pointer-events-none"></div>
                        
                        <h3 class="text-xl font-black mb-1 w-full text-left">–°—Ç–µ–∫–ª—è–Ω–Ω–∞—è –ë–∞–Ω–∫–∞</h3>
                        <p class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest w-full text-left mb-6">+5% –≤ –Ω–µ–¥–µ–ª—é (–∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)</p>

                        <!-- Jar Visual -->
                        <div class="relative w-32 h-40 border-4 border-white/20 rounded-[2rem] rounded-t-lg backdrop-blur-sm bg-white/5 overflow-hidden mb-6 flex flex-col justify-end">
                            <!-- Lid -->
                            <div class="absolute -top-1 -left-1 -right-1 h-3 bg-white/20 rounded-t-md"></div>
                            <!-- Liquid -->
                            <div id="jar-liquid" class="w-full bg-gradient-to-t from-green-500/80 to-green-400/50 jar-liquid relative" style="height: 0%">
                                <div class="absolute top-0 left-0 w-full h-[2px] bg-white/50"></div>
                            </div>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <span class="text-2xl opacity-50">ü´ô</span>
                            </div>
                        </div>

                        <div class="w-full flex justify-between items-end mb-4 px-2">
                             <div>
                                 <p class="text-[9px] text-neutral-500 uppercase font-bold">–ù–∞–∫–æ–ø–ª–µ–Ω–æ</p>
                                 <p id="jar-balance-display" class="text-2xl font-black text-green-400">0.00</p>
                             </div>
                             <div class="text-right">
                                 <p class="text-[9px] text-neutral-500 uppercase font-bold">–î–æ—Ö–æ–¥</p>
                                 <p id="jar-profit-display" class="text-sm font-bold text-green-500">+0.00</p>
                             </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 w-full">
                            <button onclick="openModal('jar-dep')" class="h-12 glass-panel hover:bg-white/10 rounded-xl font-bold text-xs uppercase">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                            <button onclick="claimJar()" class="h-12 glass-panel hover:bg-white/10 rounded-xl font-bold text-xs uppercase text-green-400">–°–Ω—è—Ç—å –≤—Å—ë</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Referrals -->
                <div id="tab-referrals" class="tab-content space-y-6">
                    <div class="dool-card rounded-[2.5rem] p-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 gradient-bg blur-[60px] opacity-20"></div>
                        <h3 class="text-2xl font-black mb-2 relative z-10">–ü–∞—Ä—Ç–Ω–µ—Ä–∫–∞</h3>
                        <p class="text-neutral-500 text-xs mb-8 leading-relaxed max-w-[80%] relative z-10">–ü–æ–ª—É—á–∏ <span class="text-white font-bold">10.00 ƒê</span> –∑–∞ –¥—Ä—É–≥–∞.</p>
                        
                        <div class="bg-black/40 border border-white/5 p-4 rounded-2xl space-y-3 relative z-10 backdrop-blur-sm">
                            <div class="flex items-center justify-between gap-4">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[9px] font-black text-neutral-600 uppercase tracking-widest mb-1">–°—Å—ã–ª–∫–∞</p>
                                    <input readonly id="ref-link" class="w-full text-[10px] font-mono text-neutral-400 bg-transparent outline-none truncate" value="...">
                                </div>
                                <button onclick="shareRef()" class="w-10 h-10 flex items-center justify-center bg-white text-black rounded-xl hover:scale-105 transition-transform">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="dool-card p-5 rounded-[2rem] flex flex-col items-center justify-center">
                            <p id="ref-count" class="text-3xl font-black">0</p>
                            <p class="text-[9px] font-bold text-neutral-600 uppercase tracking-wider">–î—Ä—É–∑–µ–π</p>
                        </div>
                        <div class="dool-card p-5 rounded-[2rem] flex flex-col items-center justify-center">
                            <p id="ref-earned" class="text-3xl font-black text-[#FF4D00]">0</p>
                            <p class="text-[9px] font-bold text-neutral-600 uppercase tracking-wider">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Settings -->
                <div id="tab-settings" class="tab-content space-y-6">
                    <div class="dool-card rounded-[2.5rem] p-6">
                        <h3 class="text-xl font-black mb-6">–ü—Ä–æ—Ñ–∏–ª—å</h3>
                        <div class="flex items-center gap-4 mb-6">
                            <div class="relative group cursor-pointer">
                                <img id="settings-avatar" src="" class="w-16 h-16 rounded-full object-cover bg-neutral-800">
                                <label class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                                    <input type="file" id="avatar-input-settings" class="hidden" accept="image/*">
                                </label>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p id="settings-email" class="font-bold text-sm truncate">...</p>
                                <p class="text-[10px] text-neutral-500 uppercase tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- Privacy Toggle -->
                            <div class="flex items-center justify-between p-3 bg-white/5 rounded-2xl">
                                <div>
                                    <p class="font-bold text-sm">–ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å</p>
                                    <p class="text-[10px] text-neutral-500">–°–∫—Ä—ã–≤–∞—Ç—å email –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ</p>
                                </div>
                                <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="toggle-anon" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 border-[#111] appearance-none cursor-pointer transition-all duration-300 left-0"/>
                                    <label for="toggle-anon" class="toggle-label block overflow-hidden h-6 rounded-full bg-neutral-800 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="btn-logout" class="w-full h-14 border border-red-500/30 text-red-500 rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-red-500/10 transition-colors">–í—ã–π—Ç–∏</button>
                    <p class="text-center text-[9px] text-neutral-700 font-mono">Doolcoin Wallet v2.0</p>
                </div>

            </main>

            <!-- Navigation Bar -->
            <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] max-w-[400px] h-16 bg-[#111]/90 backdrop-blur-xl border border-white/10 rounded-[2rem] flex items-center justify-around px-1 z-50 shadow-2xl">
                <button onclick="switchTab('wallet')" id="nav-wallet" class="nav-btn flex-1 h-full rounded-[1.5rem] flex items-center justify-center text-orange-500">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                </button>
                <button onclick="switchTab('invest')" id="nav-invest" class="nav-btn flex-1 h-full rounded-[1.5rem] flex items-center justify-center text-neutral-600 hover:text-white transition-colors">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                </button>
                <button onclick="switchTab('referrals')" id="nav-referrals" class="nav-btn flex-1 h-full rounded-[1.5rem] flex items-center justify-center text-neutral-600 hover:text-white transition-colors">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                </button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn flex-1 h-full rounded-[1.5rem] flex items-center justify-center text-neutral-600 hover:text-white transition-colors">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
            </nav>
        </div>

        <!-- Modals -->

        <!-- Referral Info Modal -->
        <div id="modal-ref-info" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-8 opacity-0 transition-opacity duration-300">
             <div class="bg-[#111] border border-white/10 p-8 rounded-[2.5rem] text-center max-w-xs w-full relative overflow-hidden transform scale-90 transition-transform" id="modal-ref-info-content">
                 <div class="absolute top-0 right-0 w-full h-full gradient-bg opacity-[0.05]"></div>
                 <div class="w-16 h-16 bg-[#FF4D00]/20 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl animate-bounce">üéÅ</div>
                 <h2 class="text-xl font-black mb-2 relative z-10">–í–∞—Å –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏!</h2>
                 <p class="text-xs text-neutral-400 mb-6 relative z-10">–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ —Å—Å—ã–ª–∫–µ –¥—Ä—É–≥–∞.</p>
                 <div class="bg-white/5 rounded-2xl p-4 mb-6 border border-white/5 relative z-10">
                     <p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–ü—Ä–∏–≥–ª–∞—Å–∏–ª</p>
                     <p id="ref-inviter-email" class="font-bold text-white truncate">...</p>
                     <div class="mt-3 pt-3 border-t border-white/10">
                         <p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–í–∞—à –±–æ–Ω—É—Å</p>
                         <p class="text-xl font-black text-[#FF4D00]">+10.00 ƒê</p>
                     </div>
                 </div>
                 <button onclick="closeModal('ref-info')" class="w-full h-12 bg-white text-black rounded-xl font-black text-xs uppercase tracking-wider hover:bg-neutral-200 cursor-pointer relative z-10">–ö—Ä—É—Ç–æ!</button>
             </div>
        </div>

        <!-- Trade Modals (Buy/Sell) -->
        <div id="modal-trade-buy" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
            <div class="bg-[#111] border-t border-white/10 rounded-t-[2.5rem] p-8 pb-10 transform translate-y-full transition-transform duration-300" id="modal-trade-buy-content">
                <h2 class="text-2xl font-black mb-6">–ö—É–ø–∏—Ç—å Beta</h2>
                <div class="space-y-4">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Œ≤</p>
                        <input type="number" id="buy-beta-amt" placeholder="0.00" class="w-full bg-transparent text-2xl font-black outline-none">
                    </div>
                    <div class="flex justify-between px-2 text-xs font-bold text-neutral-500">
                        <span>–¶–µ–Ω–∞: <span id="trade-buy-price" class="text-white">...</span> ƒê</span>
                        <span>–ò—Ç–æ–≥–æ: <span id="trade-buy-total" class="text-[#FF4D00]">0.00</span> ƒê</span>
                    </div>
                    <button id="btn-do-buy" class="w-full h-14 bg-green-500 text-black rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-green-400 mt-4">–ö—É–ø–∏—Ç—å</button>
                    <button onclick="closeModal('trade-buy')" class="w-full h-12 text-neutral-500 font-bold uppercase text-[10px]">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <div id="modal-trade-sell" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
            <div class="bg-[#111] border-t border-white/10 rounded-t-[2.5rem] p-8 pb-10 transform translate-y-full transition-transform duration-300" id="modal-trade-sell-content">
                <h2 class="text-2xl font-black mb-6">–ü—Ä–æ–¥–∞—Ç—å Beta</h2>
                <div class="space-y-4">
                     <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Œ≤</p>
                        <input type="number" id="sell-beta-amt" placeholder="0.00" class="w-full bg-transparent text-2xl font-black outline-none">
                    </div>
                    <div class="flex justify-between px-2 text-xs font-bold text-neutral-500">
                         <span>–î–æ—Å—Ç—É–ø–Ω–æ: <span id="trade-sell-max" class="text-white">...</span> Œ≤</span>
                        <span>–ü–æ–ª—É—á–∏—Ç–µ: <span id="trade-sell-total" class="text-[#FF4D00]">0.00</span> ƒê</span>
                    </div>
                    <button id="btn-do-sell" class="w-full h-14 bg-red-500 text-black rounded-2xl font-black text-xs uppercase tracking-wider hover:bg-red-400 mt-4">–ü—Ä–æ–¥–∞—Ç—å</button>
                    <button onclick="closeModal('trade-sell')" class="w-full h-12 text-neutral-500 font-bold uppercase text-[10px]">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <!-- Jar Deposit Modal -->
        <div id="modal-jar-dep" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
             <div class="bg-[#111] border-t border-white/10 rounded-t-[2.5rem] p-8 pb-10 transform translate-y-full transition-transform duration-300" id="modal-jar-dep-content">
                <h2 class="text-2xl font-black mb-6">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –ë–∞–Ω–∫—É</h2>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 mb-4">
                     <input type="number" id="jar-amt-in" placeholder="0.00" class="w-full bg-transparent text-3xl font-black outline-none text-green-400">
                     <p class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mt-1">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="jar-avail-bal">...</span> ƒê</p>
                </div>
                <button onclick="depositJar()" class="w-full h-14 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-wider">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                <button onclick="closeModal('jar-dep')" class="w-full h-12 text-neutral-500 font-bold uppercase text-[10px] mt-2">–û—Ç–º–µ–Ω–∞</button>
             </div>
        </div>

        <!-- Send/Receive/Scan Modals (Existing, optimized) -->
        <div id="modal-send" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
            <div class="bg-[#0f0f0f] border-t border-white/10 rounded-t-[2.5rem] p-8 pb-10 transform translate-y-full transition-transform duration-300" id="modal-send-content">
                <h2 class="text-2xl font-black mb-6 px-2">–ü–µ—Ä–µ–≤–æ–¥</h2>
                <div class="space-y-3">
                    <input type="email" id="send-email" placeholder="email@example.com" class="w-full bg-white/5 rounded-2xl px-5 py-4 outline-none font-bold text-sm">
                    <div class="bg-white/5 rounded-2xl p-4 flex items-center gap-2">
                        <input type="number" id="send-amt" placeholder="0.00" class="w-full bg-transparent outline-none font-black text-3xl">
                        <span class="text-xl font-black text-orange-500">ƒê</span>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button onclick="closeModal('send')" class="flex-1 h-14 bg-white/5 text-neutral-400 rounded-2xl font-bold text-xs uppercase">–û—Ç–º–µ–Ω–∞</button>
                        <button id="btn-do-send" class="flex-[2] h-14 bg-white text-black rounded-2xl font-black text-xs uppercase">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-receive" class="hidden absolute inset-0 z-[120] bg-black/80 backdrop-blur-xl flex flex-col justify-end opacity-0 transition-opacity duration-300">
             <div class="bg-[#111] border-t border-white/10 rounded-t-[2.5rem] p-8 pb-10 w-full transform translate-y-full transition-transform duration-300" id="modal-receive-content">
                <h2 class="text-2xl font-black mb-6 text-center">–ü–æ–ª—É—á–∏—Ç—å</h2>
                <div class="flex justify-center mb-6">
                    <div class="bg-white p-4 rounded-3xl" id="qrcode-container"></div>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl flex items-center justify-between cursor-pointer active:bg-white/10 transition-colors" onclick="navigator.clipboard.writeText(auth.currentUser.email); showT('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', '–ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')">
                     <p id="my-email-addr" class="font-mono text-orange-500 truncate text-sm px-2">...</p>
                     <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                </div>
                <button onclick="closeModal('receive')" class="w-full mt-6 h-12 text-neutral-500 font-bold uppercase text-[10px]">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        
        <div id="modal-scan" class="hidden absolute inset-0 z-[120] bg-black flex flex-col opacity-0 transition-opacity duration-300">
             <div class="absolute top-6 right-6 z-20">
                 <button onclick="closeModal('scan')" class="w-10 h-10 bg-white/10 backdrop-blur rounded-full flex items-center justify-center text-white"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
             </div>
             <div class="w-full h-full relative bg-black" id="modal-scan-content">
                 <div id="reader"></div>
                 <div class="scan-focus-area"><div class="absolute inset-0 border-2 border-[#FF4D00] rounded-[2rem] shadow-[0_0_20px_rgba(255,77,0,0.3)]"></div><div class="scan-laser"></div></div>
             </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, runTransaction, Timestamp, increment, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBoFuGY-SSmcGHPGzuWZbdGFeI9_aaAKs8",
          authDomain: "doolcoinwallet.firebaseapp.com",
          projectId: "doolcoinwallet",
          storageBucket: "doolcoinwallet.firebasestorage.app",
          messagingSenderId: "473549726148",
          appId: "1:473549726148:web:87663b4944330c0df58491"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let myData = null;
        let marketData = null;
        let jarInterval = null;
        let html5QrCode = null;

        // --- Core System Init ---
        
        // Ensure Market Exists (First time run)
        const initSystem = async () => {
            const mRef = doc(db, 'system', 'market');
            const snap = await getDoc(mRef);
            if (!snap.exists()) {
                await setDoc(mRef, {
                    pool_dool: 10000000,
                    total_beta: 10000000,
                    history: [] // For chart
                });
            }
        };

        // --- Referral Logic (Local Storage) ---
        const urlParams = new URLSearchParams(window.location.search);
        const refParam = urlParams.get('ref');
        if (refParam) {
            localStorage.setItem('dool_ref', refParam.toLowerCase());
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- Auth State ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                await initSystem();
                const userRef = doc(db, "users", u.uid);
                const snap = await getDoc(userRef);

                if (!snap.exists()) {
                    // Registration
                    const savedRef = localStorage.getItem('dool_ref');
                    const newUser = {
                        email: u.email,
                        lowercaseEmail: u.email.toLowerCase(),
                        balance: 10.0,
                        avatar: u.photoURL || '',
                        refCount: 0,
                        refEarned: 0,
                        isAnonymous: false,
                        wallet_beta: 0,
                        jar_balance: 0,
                        jar_start: Timestamp.now(),
                        invitedBy: savedRef || null,
                        createdAt: Timestamp.now()
                    };
                    await setDoc(userRef, newUser);

                    // Ref Bonus
                    if (savedRef && savedRef !== u.email.toLowerCase()) {
                        const q = query(collection(db, "users"), where("lowercaseEmail", "==", savedRef));
                        const rSnap = await getDocs(q);
                        if (!rSnap.empty) {
                            await updateDoc(rSnap.docs[0].ref, {
                                balance: increment(10),
                                refCount: increment(1),
                                refEarned: increment(10)
                            });
                        }
                    }
                    localStorage.removeItem('dool_ref');
                } else {
                    // Check & Add new fields if missing (Migration)
                    const d = snap.data();
                    const updates = {};
                    if(d.isAnonymous === undefined) updates.isAnonymous = false;
                    if(d.wallet_beta === undefined) updates.wallet_beta = 0;
                    if(d.jar_balance === undefined) updates.jar_balance = 0;
                    if(d.jar_start === undefined) updates.jar_start = Timestamp.now();
                    if(Object.keys(updates).length > 0) await updateDoc(userRef, updates);
                }
                
                startApp(u);
            } else {
                showAuth();
                // Check if we have a pending ref to show the gift button
                const savedRef = localStorage.getItem('dool_ref');
                if (savedRef) {
                    const btn = document.getElementById('btn-ref-gift');
                    btn.classList.remove('hidden');
                    document.getElementById('ref-inviter-email').textContent = savedRef;
                }
            }
        });

        function showAuth() {
            document.getElementById('view-loading').classList.add('hidden');
            document.getElementById('view-main').classList.add('hidden');
            document.getElementById('view-auth').classList.replace('hidden', 'flex');
        }

        // --- Main Logic ---

        function startApp(u) {
            document.getElementById('view-auth').classList.add('hidden');
            document.getElementById('view-loading').classList.add('hidden');
            document.getElementById('view-main').classList.replace('hidden', 'flex');
            document.getElementById('main-username').textContent = u.email;
            document.getElementById('settings-email').textContent = u.email;
            
            // Clean URL link
            const cleanUrl = window.location.href.split('?')[0];
            document.getElementById('ref-link').value = `${cleanUrl}?ref=${u.email}`;

            // User Listener
            onSnapshot(doc(db, "users", u.uid), (snap) => {
                const d = snap.data();
                if(!d) return;
                myData = d;

                // Balance
                document.getElementById('balance-val').textContent = d.balance.toFixed(2);
                
                // Avatar
                const av = d.avatar || `https://ui-avatars.com/api/?background=random&color=fff&name=${u.email.charAt(0)}`;
                document.getElementById('main-avatar').src = av;
                document.getElementById('toast-avatar').src = av;
                document.getElementById('settings-avatar').src = av;

                // Refs
                document.getElementById('ref-count').textContent = d.refCount || 0;
                document.getElementById('ref-earned').textContent = (d.refEarned || 0).toFixed(2);

                // Settings
                document.getElementById('toggle-anon').checked = d.isAnonymous || false;

                // Investments
                document.getElementById('my-beta-bal').textContent = (d.wallet_beta || 0).toFixed(4);
                
                // Jar (Start Calculator)
                startJarCalc(d);
            });

            // Transactions Listener
            const qTx = query(collection(db, "transactions"), where("parties", "array-contains", u.email), orderBy('date', 'desc'), limit(20));
            onSnapshot(qTx, (snap) => {
                const list = document.getElementById('tx-history');
                if (snap.empty) { list.innerHTML = '<p class="text-center text-neutral-800 text-[10px] font-bold py-4">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>'; return; }
                
                let html = '';
                snap.docs.forEach(d => {
                    const tx = d.data();
                    const isSent = tx.from === u.email;
                    // Anon logic: If I received, and sender was anon -> Show Anon
                    let displayPartner = isSent ? tx.to : tx.from;
                    let displayAvatar = `https://ui-avatars.com/api/?background=222&color=666&name=${displayPartner.charAt(0)}`;
                    
                    if (!isSent && tx.isAnonymous) {
                         displayPartner = "–ê–Ω–æ–Ω–∏–º";
                         displayAvatar = "https://ui-avatars.com/api/?background=000&color=333&name=?";
                    }

                    html += `
                    <div class="flex items-center justify-between p-4 rounded-[1.5rem] bg-white/[0.03] border border-white/5">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <img src="${displayAvatar}" class="w-10 h-10 rounded-full bg-neutral-800 object-cover border border-white/5 shrink-0">
                            <div class="min-w-0">
                                <p class="text-[9px] font-black uppercase ${isSent ? 'text-neutral-500' : 'text-[#FF4D00]'} tracking-widest mb-0.5">${isSent ? '–ö–æ–º—É:' : '–û—Ç:'}</p>
                                <p class="text-[11px] font-bold text-white truncate w-32 leading-tight">${displayPartner}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black ${isSent ? 'text-white' : 'text-[#FF4D00]'}">${isSent ? '-' : '+'}${tx.amount.toFixed(2)}</p>
                        </div>
                    </div>`;
                });
                list.innerHTML = html;
            });

            // Market Listener
            onSnapshot(doc(db, "system", "market"), (snap) => {
                marketData = snap.data();
                if(marketData) updateMarketUI();
            });
        }

        // --- Market Logic (Beta) ---
        function getBetaPrice() {
            if(!marketData) return 1.0;
            return marketData.pool_dool / marketData.total_beta;
        }

        function updateMarketUI() {
            const price = getBetaPrice();
            document.getElementById('beta-price').textContent = price.toFixed(4) + ' ƒê';
            
            // Draw Chart (Simulated History based on price fluctuations or real history)
            // For this demo, we'll generate a simple path based on history or random if empty
            // Ideally marketData.history contains [{t, p}, ...]
            
            // Let's visualize the last 10 points or just a flat line if new
            const chart = document.getElementById('beta-chart');
            const w = 300; // viewBox width roughly
            const h = 100;
            
            // Simple visualizer: line going slightly up or down based on price
            // We really need history for a chart. Let's assume we push price to history on transactions.
            // Mocking a line for "Imba" effect if history is empty
            let points = "0,50 50,45 100,60 150,40 200,55 250,30 300,50"; 
            
            // Update paths
            document.getElementById('chart-line-path').setAttribute('d', `M${points}`);
            document.getElementById('chart-area-path').setAttribute('d', `M${points} L300,100 L0,100 Z`);
            
            // Calculations for Buy/Sell Modal
            const buyAmt = parseFloat(document.getElementById('buy-beta-amt').value) || 0;
            document.getElementById('trade-buy-price').textContent = price.toFixed(4);
            document.getElementById('trade-buy-total').textContent = (buyAmt * price).toFixed(2);
            
            const sellAmt = parseFloat(document.getElementById('sell-beta-amt').value) || 0;
            document.getElementById('trade-sell-max').textContent = (myData?.wallet_beta || 0).toFixed(4);
            document.getElementById('trade-sell-total').textContent = (sellAmt * price).toFixed(2);
        }

        document.getElementById('buy-beta-amt').oninput = updateMarketUI;
        document.getElementById('sell-beta-amt').oninput = updateMarketUI;

        // Buy Beta
        document.getElementById('btn-do-buy').onclick = async () => {
            const amtBeta = parseFloat(document.getElementById('buy-beta-amt').value);
            if(amtBeta <= 0) return showT('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
            
            await runTransaction(db, async (t) => {
                const mDoc = await t.get(doc(db, "system", "market"));
                const uDoc = await t.get(doc(db, "users", auth.currentUser.uid));
                
                const m = mDoc.data();
                const u = uDoc.data();
                const price = m.pool_dool / m.total_beta;
                const cost = amtBeta * price;

                if(u.balance < cost) throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

                // Update Market: User gives Dool (Pool Up), User Gets Beta.
                // Formula: Price = Pool / Supply. 
                // To keep price logical: If user BUYS, they are adding Dool to pool.
                t.update(doc(db, "system", "market"), {
                    pool_dool: increment(cost)
                });
                
                t.update(uDoc.ref, {
                    balance: increment(-cost),
                    wallet_beta: increment(amtBeta)
                });
            }).then(() => {
                closeModal('trade-buy');
                showT('–£—Å–ø–µ—à–Ω–æ', `–ö—É–ø–ª–µ–Ω–æ ${amtBeta} Œ≤`);
                document.getElementById('buy-beta-amt').value = '';
            }).catch(e => showT('–û—à–∏–±–∫–∞', e.message, '', null, true));
        };

        // Sell Beta
        document.getElementById('btn-do-sell').onclick = async () => {
            const amtBeta = parseFloat(document.getElementById('sell-beta-amt').value);
            if(amtBeta <= 0) return showT('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
            
            await runTransaction(db, async (t) => {
                const mDoc = await t.get(doc(db, "system", "market"));
                const uDoc = await t.get(doc(db, "users", auth.currentUser.uid));
                
                const m = mDoc.data();
                const u = uDoc.data();
                const price = m.pool_dool / m.total_beta;
                const receive = amtBeta * price;

                if(u.wallet_beta < amtBeta) throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Œ≤");
                if(m.pool_dool < receive) throw new Error("–ù–µ—Ç –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏");

                t.update(doc(db, "system", "market"), {
                    pool_dool: increment(-receive)
                });
                
                t.update(uDoc.ref, {
                    balance: increment(receive),
                    wallet_beta: increment(-amtBeta)
                });
            }).then(() => {
                closeModal('trade-sell');
                showT('–£—Å–ø–µ—à–Ω–æ', `–ü—Ä–æ–¥–∞–Ω–æ ${amtBeta} Œ≤`);
                document.getElementById('sell-beta-amt').value = '';
            }).catch(e => showT('–û—à–∏–±–∫–∞', e.message, '', null, true));
        };


        // --- Glass Jar (Staking) Logic ---
        
        function startJarCalc(user) {
            if(jarInterval) clearInterval(jarInterval);
            const jarBal = user.jar_balance || 0;
            if (jarBal === 0) {
                 document.getElementById('jar-balance-display').textContent = "0.00";
                 document.getElementById('jar-profit-display').textContent = "+0.00";
                 document.getElementById('jar-liquid').style.height = "0%";
                 return;
            }

            const startTime = user.jar_start.toMillis();
            const ratePerWeek = 0.05; // 5%
            const ratePerMs = ratePerWeek / (7 * 24 * 3600 * 1000);

            const update = () => {
                const now = Date.now();
                const diffMs = now - startTime;
                
                // Simple interest over time for visual or Compound?
                // Continuous Compounding formula: A = P * e^(rt)
                // Let's use simple compound simulation based on linear time for UI smoothness
                // Profit = Principal * (ratePerMs * diffMs)
                const profit = jarBal * (ratePerMs * diffMs);
                const total = jarBal + profit;
                
                document.getElementById('jar-balance-display').textContent = total.toFixed(6);
                document.getElementById('jar-profit-display').textContent = "+" + profit.toFixed(6);
                
                // Liquid height (visual cap at 200% fill visual)
                let fill = (total / 100) * 5; // Arbitrary scale visual
                if (fill > 100) fill = 100;
                if (fill < 10) fill = 10; // min
                document.getElementById('jar-liquid').style.height = fill + "%";
            };
            jarInterval = setInterval(update, 100);
            update();
        }

        window.depositJar = async () => {
            const amt = parseFloat(document.getElementById('jar-amt-in').value);
            if (!amt || amt <= 0) return;
            if (amt > myData.balance) return showT('–û—à–∏–±–∫–∞', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');

            // Logic: When adding, we must "realize" the current interest of existing jar, 
            // add it to principal, add new deposit, and reset timer.
            // Actually, simpler: Jar stores "Principal". Interest is calculated dynamically.
            // But to add to it, we need to "claim" internal interest first to merge it.
            
            // SIMPLIFIED MODEL: Claim current total (Princ + Interest) -> Add new Amt -> New Principal -> Reset Timer.
            try {
                await runTransaction(db, async (t) => {
                    const ref = doc(db, "users", auth.currentUser.uid);
                    const d = (await t.get(ref)).data();
                    
                    const now = Date.now();
                    const start = d.jar_start.toMillis();
                    const diffMs = now - start;
                    const ratePerWeek = 0.05;
                    const ratePerMs = ratePerWeek / (604800000);
                    const currentProfit = d.jar_balance * (ratePerMs * diffMs);
                    
                    const newPrincipal = d.jar_balance + currentProfit + amt;
                    
                    t.update(ref, {
                        balance: increment(-amt),
                        jar_balance: newPrincipal,
                        jar_start: Timestamp.now()
                    });
                });
                closeModal('jar-dep');
                showT('–°–µ–π—Ñ', '–î–µ–ø–æ–∑–∏—Ç —É—Å–ø–µ—à–µ–Ω');
                document.getElementById('jar-amt-in').value = '';
            } catch(e) { console.log(e); }
        };

        window.claimJar = async () => {
             if (!myData.jar_balance || myData.jar_balance <= 0) return;
             try {
                await runTransaction(db, async (t) => {
                    const ref = doc(db, "users", auth.currentUser.uid);
                    const d = (await t.get(ref)).data();
                    
                    const now = Date.now();
                    const start = d.jar_start.toMillis();
                    const ratePerWeek = 0.05;
                    const ratePerMs = ratePerWeek / (604800000);
                    const currentProfit = d.jar_balance * (ratePerMs * diffMs);
                    const total = d.jar_balance + currentProfit;
                    
                    t.update(ref, {
                        balance: increment(total),
                        jar_balance: 0,
                        jar_start: Timestamp.now()
                    });
                });
                showT('–°–µ–π—Ñ', '–°—Ä–µ–¥—Å—Ç–≤–∞ –≤—ã–≤–µ–¥–µ–Ω—ã');
            } catch(e) { console.log(e); }
        }


        // --- Settings Logic ---
        document.getElementById('toggle-anon').onchange = async (e) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { isAnonymous: e.target.checked });
            showT('–ù–∞—Å—Ç—Ä–æ–π–∫–∏', '–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        };
        
        document.getElementById('avatar-input-settings').onchange = async (e) => {
             const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { avatar: ev.target.result });
            };
            reader.readAsDataURL(file);
        }
        
        document.getElementById('btn-logout').onclick = () => signOut(auth);


        // --- Send Logic (Updated for Privacy) ---
        document.getElementById('btn-do-send').onclick = async () => {
            const to = document.getElementById('send-email').value.trim().toLowerCase();
            const amt = parseFloat(document.getElementById('send-amt').value);
            const myEmail = auth.currentUser.email;

            if (to === myEmail) return showT('–û—à–∏–±–∫–∞', '–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–±–µ', '', null, true);
            if (!amt || amt < 0.01) return showT('–û—à–∏–±–∫–∞', '–ú–∏–Ω–∏–º—É–º 0.01 ƒê', '', null, true);
            if (amt > myData.balance) return showT('–û—à–∏–±–∫–∞', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', '', null, true);

            try {
                const q = query(collection(db, "users"), where("email", "==", to));
                const res = await getDocs(q);
                if (res.empty) throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                const receiverRef = res.docs[0].ref;

                await runTransaction(db, async (t) => {
                    const senderRef = doc(db, "users", auth.currentUser.uid);
                    const sDoc = await t.get(senderRef);
                    if (sDoc.data().balance < amt) throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

                    t.update(senderRef, { balance: increment(-amt) });
                    t.update(receiverRef, { balance: increment(amt) });
                    
                    const txRef = doc(collection(db, "transactions"));
                    t.set(txRef, { 
                        from: myEmail, 
                        to: to, 
                        amount: amt, 
                        date: Timestamp.now(), 
                        parties: [myEmail, to],
                        isAnonymous: myData.isAnonymous || false // Save privacy state snapshot
                    });
                });
                
                closeModal('send');
                showT('–£—Å–ø–µ—à–Ω–æ', `–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω`, `-${amt.toFixed(2)} ƒê`);
                document.getElementById('send-amt').value = '';
                document.getElementById('send-email').value = '';
            } catch (e) { showT('–û—à–∏–±–∫–∞', e.message, '', null, true); }
        };

        // --- UI Utils ---
        window.openModal = (n) => {
            if(n === 'jar-dep') { document.getElementById('jar-avail-bal').textContent = myData.balance.toFixed(2); }
            const m = document.getElementById('modal-'+n);
            const c = document.getElementById(`modal-${n}-content`);
            m.classList.remove('hidden');
            void m.offsetWidth; // trigger reflow
            m.classList.remove('opacity-0');
            if(c) c.classList.remove('translate-y-full', 'scale-90');
            if(n === 'receive') {
                document.getElementById('qrcode-container').innerHTML = '';
                new QRCode(document.getElementById('qrcode-container'), { text: auth.currentUser.email, width: 200, height: 200 });
                document.getElementById('my-email-addr').textContent = auth.currentUser.email;
            }
            if(n === 'scan') startScanner();
        };

        window.closeModal = (n) => {
            const m = document.getElementById('modal-'+n);
            const c = document.getElementById(`modal-${n}-content`);
            m.classList.add('opacity-0');
            if(c) c.classList.add('translate-y-full', 'scale-90');
            setTimeout(() => m.classList.add('hidden'), 300);
            if(n === 'scan') stopScanner();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('text-orange-500');
                b.classList.add('text-neutral-600');
            });
            document.getElementById('nav-'+tab).classList.replace('text-neutral-600', 'text-orange-500');
        };

        window.showT = (title, msg, amt = '', sender = null, err = false) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-msg').textContent = msg;
            const aEl = document.getElementById('toast-amount');
            if(amt) { aEl.textContent = amt; aEl.classList.remove('hidden'); } else aEl.classList.add('hidden');
            document.getElementById('toast-status').className = `absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-black flex items-center justify-center ${err ? 'bg-red-500' : 'bg-green-500'}`;
            t.classList.add('active');
            setTimeout(() => t.classList.remove('active'), 4000);
        };

        function startScanner() {
             if (html5QrCode) return;
             html5QrCode = new Html5Qrcode("reader");
             html5QrCode.start({ facingMode: "environment" }, { fps: 10 }, (decoded) => {
                 closeModal('scan');
                 if(decoded.includes('@')) {
                     openModal('send');
                     document.getElementById('send-email').value = decoded;
                 } else showT('–û—à–∏–±–∫–∞', 'QR –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω', '', null, true);
             });
        }
        function stopScanner() { if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()); html5QrCode = null; }

        window.shareRef = async () => {
            const link = document.getElementById('ref-link').value;
            if (navigator.share) navigator.share({ title: 'Doolcoin', url: link });
            else { navigator.clipboard.writeText(link); showT('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', ''); }
        }

        // --- Init Events ---
        document.getElementById('btn-login').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(e=>showT('–û—à–∏–±–∫–∞',e.message,'',null,true));
        document.getElementById('btn-register').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(e=>showT('–û—à–∏–±–∫–∞',e.message,'',null,true));
        document.getElementById('btn-google').onclick = () => signInWithPopup(auth, googleProvider).catch(e=>console.log(e));

    </script>
</body>
</html>