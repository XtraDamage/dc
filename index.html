<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doolcoin Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    backgroundImage: {
                        'dool-gradient': 'linear-gradient(135deg, #FF4D00 0%, #FF8A00 50%, #FF005C 100%)',
                        'glass': 'linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #000000; color: #ffffff; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        
        .dool-card {
            background: #0a0a0a;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7);
        }

        .tab-content { display: none; width: 100%; }
        .tab-content.active { display: block; animation: tabFade 0.3s ease-out; }
        @keyframes tabFade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #notification { transform: translateY(-120%); transition: transform 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.27); }
        #notification.active { transform: translateY(0); }

        .avatar-ring { padding: 2px; background: linear-gradient(135deg, #FF4D00, #FF005C); border-radius: 999px; }
        
        .logo-glow { filter: drop-shadow(0 0 10px rgba(255, 77, 0, 0.4)); }
    </style>
</head>
<body class="font-sans antialiased">

    <div id="app" class="relative w-full max-w-[480px] mx-auto h-[100dvh] flex flex-col">
        
        <!-- –£–ú–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
        <div id="notification" class="fixed top-4 left-4 right-4 z-[200] bg-[#111] border border-white/10 p-4 rounded-3xl flex items-center gap-4 pointer-events-none shadow-2xl">
            <div class="w-10 h-10 bg-dool-gradient rounded-full flex items-center justify-center font-bold text-white shrink-0">ƒê</div>
            <div>
                <h4 id="notif-title" class="text-[10px] font-black uppercase text-orange-500 tracking-widest">–°–∏—Å—Ç–µ–º–∞</h4>
                <p id="notif-body" class="text-sm font-medium text-white/90">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</p>
            </div>
        </div>

        <!-- –ó–ê–ì–†–£–ó–ö–ê -->
        <div id="view-loading" class="absolute inset-0 z-[100] bg-black flex flex-col items-center justify-center">
            <div class="text-6xl font-black bg-dool-gradient bg-clip-text text-transparent logo-glow animate-pulse">ƒê</div>
        </div>

        <!-- –í–•–û–î / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
        <div id="view-auth" class="hidden flex-col h-full p-10 z-50 bg-black">
            <div class="flex-1 flex flex-col justify-center">
                <div class="mb-14 text-center">
                    <div class="text-7xl font-black bg-dool-gradient bg-clip-text text-transparent mb-4 logo-glow">ƒê</div>
                    <h1 class="text-3xl font-extrabold tracking-tight">Doolcoin</h1>
                </div>
                <div class="space-y-4">
                    <input type="email" id="auth-email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-sm font-medium outline-none focus:border-orange-500/50 transition-all">
                    <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-sm font-medium outline-none focus:border-orange-500/50 transition-all">
                    <div class="flex flex-col gap-3 pt-6">
                        <button id="btn-login" class="w-full bg-white text-black h-16 rounded-2xl font-bold active:scale-95 transition-all">–í–æ–π—Ç–∏</button>
                        <button id="btn-register" class="w-full border border-white/10 text-white h-16 rounded-2xl font-bold active:scale-95 transition-all">–°–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù -->
        <div id="view-main" class="hidden flex-col h-full">
            <header class="px-6 pt-12 pb-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div id="user-avatar-container" onclick="openModal('profile')" class="cursor-pointer relative">
                        <div class="avatar-ring">
                            <div id="user-avatar" class="w-12 h-12 bg-neutral-900 rounded-full flex items-center justify-center text-sm font-bold border-2 border-black overflow-hidden">
                                <!-- –°—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—Å—è —Ñ–æ—Ç–æ –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª—ã -->
                            </div>
                        </div>
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">–ö–æ—à–µ–ª–µ–∫</p>
                        <h4 id="user-display" class="text-sm font-bold text-neutral-100 truncate max-w-[120px]">...</h4>
                    </div>
                </div>
                <button id="btn-logout" class="w-10 h-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-neutral-400">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </header>

            <main class="flex-1 overflow-y-auto px-6 hide-scroll pt-4 pb-32">
                <!-- –í–ö–õ–ê–î–ö–ê –ö–û–®–ï–õ–ï–ö -->
                <div id="tab-wallet" class="tab-content active space-y-8">
                    <div class="dool-card rounded-[2.5rem] p-10 relative overflow-hidden">
                        <div class="relative z-10">
                            <span class="text-[11px] font-bold text-neutral-500 uppercase tracking-widest">–î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å</span>
                            <div class="flex items-center gap-3 mt-4">
                                <h2 class="text-6xl font-extrabold tracking-tighter" id="balance-amount">0.00</h2>
                                <span class="text-4xl font-black bg-dool-gradient bg-clip-text text-transparent italic shrink-0">ƒê</span>
                            </div>
                        </div>
                        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-dool-gradient rounded-full blur-[90px] opacity-10"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openModal('send')" class="h-16 bg-white text-black rounded-3xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                        <button onclick="openModal('receive')" class="h-16 bg-white/5 border border-white/10 rounded-3xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">
                            –ü–æ–ª—É—á–∏—Ç—å
                        </button>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-[11px] font-black text-neutral-600 uppercase tracking-[0.2em] px-2">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                        <div id="tx-list" class="space-y-3">
                            <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
                        </div>
                    </div>
                </div>

                <!-- –í–ö–õ–ê–î–ö–ê –†–ï–§–ï–†–ê–õ–´ -->
                <div id="tab-referrals" class="tab-content space-y-6">
                    <div class="dool-card rounded-[2.5rem] p-8">
                        <h3 class="text-2xl font-extrabold mb-3">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ ƒê</h3>
                        <p class="text-neutral-500 text-sm leading-relaxed mb-8">–ü–æ–ª—É—á–∞–π—Ç–µ <span class="text-white font-bold">10.00 ƒê</span> –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</p>
                        
                        <div class="bg-black border border-white/5 p-5 rounded-2xl space-y-3">
                            <span class="text-[9px] font-black text-neutral-500 uppercase tracking-widest">–í–∞—à–∞ —Å—Å—ã–ª–∫–∞</span>
                            <div class="flex items-center justify-between gap-4">
                                <span id="ref-url" class="text-[11px] font-mono text-neutral-400 truncate">...</span>
                                <button onclick="copyRef()" class="shrink-0 bg-white text-black text-[9px] px-4 py-2 rounded-xl font-bold uppercase tracking-widest">–ö–æ–ø–∏—è</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
            <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[85%] max-w-[380px] h-20 bg-[#0a0a0a]/80 backdrop-blur-3xl border border-white/5 rounded-[2.5rem] flex items-center justify-around px-4 z-50">
                <button onclick="switchTab('wallet')" class="nav-btn active flex flex-col items-center gap-1 text-orange-500" id="nav-wallet">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">–ì–ª–∞–≤–Ω–∞—è</span>
                </button>
                <button onclick="switchTab('referrals')" class="nav-btn flex flex-col items-center gap-1 text-neutral-500" id="nav-referrals">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">–ë–æ–Ω—É—Å—ã</span>
                </button>
            </nav>
        </div>

        <!-- –ú–û–î–ê–õ–ö–ê: –ü–†–û–§–ò–õ–¨ (–°–ú–ï–ù–ê –§–û–¢–û) -->
        <div id="modal-profile" class="hidden absolute inset-0 z-[120] bg-black/95 backdrop-blur-2xl flex-col items-center justify-center p-8">
            <div class="w-full max-w-[320px] text-center">
                <h2 class="text-2xl font-black mb-8">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <div class="grid grid-cols-3 gap-4 mb-10" id="avatar-selection">
                    <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ -->
                </div>
                <button onclick="closeModal('profile')" class="w-full py-4 bg-white text-black rounded-2xl font-bold uppercase text-xs tracking-widest">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–ö–ê: –ü–ï–†–ï–í–û–î -->
        <div id="modal-send" class="hidden absolute inset-0 z-[120] bg-black/90 backdrop-blur-2xl flex-col justify-end">
            <div class="bg-[#0a0a0a] border-t border-white/10 rounded-t-[3rem] p-10 animate-slide-up">
                <h2 class="text-3xl font-black mb-8">–ü–µ—Ä–µ–≤–æ–¥</h2>
                <div class="space-y-4">
                    <input type="email" id="send-email" placeholder="Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è" class="w-full bg-white/5 border border-white/5 rounded-2xl p-5 text-sm font-bold outline-none focus:border-orange-500/50">
                    <input type="number" id="send-amount" placeholder="0.00 ƒê" class="w-full bg-white/5 border border-white/5 rounded-2xl p-5 text-4xl font-black outline-none focus:border-orange-500/50">
                    <div class="flex gap-4 pt-6">
                        <button onclick="closeModal('send')" class="flex-1 py-4 font-bold text-neutral-500 uppercase text-xs">–û—Ç–º–µ–Ω–∞</button>
                        <button id="btn-submit-send" class="flex-1 bg-white text-black py-4 rounded-2xl font-black uppercase text-xs">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–ö–ê: –ü–û–õ–£–ß–ò–¢–¨ -->
        <div id="modal-receive" class="hidden absolute inset-0 z-[120] bg-black/90 backdrop-blur-2xl items-center justify-center p-8">
            <div class="bg-[#0a0a0a] border border-white/10 rounded-[3rem] p-10 w-full text-center relative">
                <button onclick="closeModal('receive')" class="absolute top-6 right-8 text-neutral-500">‚úï</button>
                <div class="text-6xl font-black bg-dool-gradient bg-clip-text text-transparent mb-6 logo-glow">ƒê</div>
                <h2 class="text-2xl font-black mb-2">–ü–æ–ª—É—á–∏—Ç—å ƒê</h2>
                <p class="text-neutral-500 text-xs mb-8">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –∞–¥—Ä–µ—Å–æ–º –ø–æ—á—Ç—ã</p>
                <div id="my-email" class="bg-white/5 p-5 rounded-2xl font-bold text-sm text-orange-500 mb-6 truncate">...</div>
                <button onclick="copyEmail()" class="w-full py-4 bg-white text-black rounded-2xl font-bold uppercase text-[10px] tracking-widest">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, orderBy, limit, runTransaction, Timestamp, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBoFuGY-SSmcGHPGzuWZbdGFeI9_aaAKs8",
          authDomain: "doolcoinwallet.firebaseapp.com",
          projectId: "doolcoinwallet",
          storageBucket: "doolcoinwallet.firebasestorage.app",
          messagingSenderId: "473549726148",
          appId: "1:473549726148:web:87663b4944330c0df58491"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myData = null;
        let lastBalance = null;
        const AVATARS = [
            'ü¶ä', 'üë§', 'üëæ', 'üíé', 'üî•', '‚≠êÔ∏è'
        ];

        // --- –£–¢–ò–õ–ò–¢–´ ---
        const showNotif = (title, body) => {
            const n = document.getElementById('notification');
            document.getElementById('notif-title').textContent = title;
            document.getElementById('notif-body').textContent = body;
            n.classList.add('active');
            setTimeout(() => n.classList.remove('active'), 4000);
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.replace('text-orange-500', 'text-neutral-500'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.getElementById('nav-'+tab).classList.replace('text-neutral-500', 'text-orange-500');
        };

        window.openModal = (n) => document.getElementById('modal-'+n).classList.replace('hidden', 'flex');
        window.closeModal = (n) => document.getElementById('modal-'+n).classList.replace('flex', 'hidden');

        // --- –õ–û–ì–ò–ö–ê –ê–í–ê–¢–ê–†–û–í ---
        const setupAvatars = () => {
            const grid = document.getElementById('avatar-selection');
            grid.innerHTML = '';
            AVATARS.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = "w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center text-3xl hover:bg-white/10 transition-all";
                btn.textContent = emoji;
                btn.onclick = async () => {
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { avatar: emoji });
                    closeModal('profile');
                    showNotif('–ü—Ä–æ—Ñ–∏–ª—å', '–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω');
                };
                grid.appendChild(btn);
            });
        };

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists()) {
                    await setDoc(doc(db, "users", user.uid), {
                        email: user.email, balance: 10.0, avatar: 'üë§', referralCount: 0, createdAt: Timestamp.now()
                    });
                }
                initApp(user);
            } else {
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('view-main').classList.add('hidden');
                document.getElementById('view-auth').classList.replace('hidden', 'flex');
            }
        });

        document.getElementById('btn-login').onclick = async () => {
            const e = document.getElementById('auth-email').value.trim();
            const p = document.getElementById('auth-password').value.trim();
            try { await signInWithEmailAndPassword(auth, e, p); } catch { showNotif('–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω—ã–π –≤—Ö–æ–¥'); }
        };

        document.getElementById('btn-register').onclick = async () => {
            const e = document.getElementById('auth-email').value.trim();
            const p = document.getElementById('auth-password').value.trim();
            if (p.length < 6) return showNotif('–ü–∞—Ä–æ–ª—å', '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
            try {
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                const ref = new URLSearchParams(window.location.search).get('ref');
                if (ref && ref !== e) {
                    const q = query(collection(db, "users"), where("email", "==", ref));
                    const snap = await getDocs(q);
                    if (!snap.empty) {
                        await updateDoc(snap.docs[0].ref, { balance: increment(10), referralCount: increment(1) });
                    }
                }
            } catch { showNotif('–û—à–∏–±–∫–∞', '–ê–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); }
        };

        // --- –û–°–ù–û–í–ù–ê–Ø –†–ê–ë–û–¢–ê ---
        function initApp(user) {
            document.getElementById('user-display').textContent = user.email;
            document.getElementById('my-email').textContent = user.email;
            document.getElementById('ref-url').textContent = `${window.location.origin}${window.location.pathname}?ref=${user.email}`;
            
            setupAvatars();

            onSnapshot(doc(db, "users", user.uid), (snap) => {
                myData = snap.data();
                if (!myData) return;
                
                if (lastBalance !== null && myData.balance > lastBalance) {
                    showNotif('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ', `+${(myData.balance - lastBalance).toFixed(2)} ƒê`);
                }
                
                document.getElementById('balance-amount').textContent = myData.balance.toFixed(2);
                document.getElementById('user-avatar').textContent = myData.avatar || 'üë§';
                lastBalance = myData.balance;

                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('view-main').classList.replace('hidden', 'flex');
            });

            // –ò–°–¢–û–†–ò–Ø –û–ü–ï–†–ê–¶–ò–ô
            const q = query(collection(db, "transactions"), where("parties", "array-contains", user.email), orderBy("date", "desc"), limit(15));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('tx-list');
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<p class="py-10 text-center text-neutral-700 text-[10px] font-bold uppercase tracking-widest">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
                    return;
                }
                snap.forEach(d => {
                    const tx = d.data();
                    const isSent = tx.from === user.email;
                    const el = document.createElement('div');
                    el.className = "p-5 rounded-[2rem] bg-white/[0.03] border border-white/[0.05] flex items-center justify-between";
                    el.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-2xl flex items-center justify-center text-lg ${isSent ? 'bg-white/5' : 'bg-orange-500/20 text-orange-500'}">
                                ${isSent ? '‚Üë' : '‚Üì'}
                            </div>
                            <div>
                                <p class="text-[9px] font-black uppercase text-neutral-500 tracking-wider">${isSent ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '–ü–æ–ª—É—á–µ–Ω–æ'}</p>
                                <p class="text-[11px] font-bold text-neutral-200 truncate w-32">${isSent ? tx.to : tx.from}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black ${isSent ? 'text-white' : 'text-orange-500'}">${isSent ? '-' : '+'}${tx.amount.toFixed(2)}</p>
                            <p class="text-[8px] text-neutral-700 font-bold">${tx.date.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                        </div>
                    `;
                    list.appendChild(el);
                });
            }, (err) => console.log(err));
        }

        // --- –¢–†–ê–ù–ó–ê–ö–¶–ò–ò ---
        document.getElementById('btn-submit-send').onclick = async () => {
            const to = document.getElementById('send-email').value.trim().toLowerCase();
            const amt = parseFloat(document.getElementById('send-amount').value);
            
            if (to === auth.currentUser.email) return showNotif('–û—à–∏–±–∫–∞', '–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–±–µ');
            if (!amt || amt <= 0 || amt > myData.balance) return showNotif('–û—à–∏–±–∫–∞', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É–º–º—É');

            const btn = document.getElementById('btn-submit-send');
            btn.disabled = true; btn.textContent = '...';

            try {
                await runTransaction(db, async (tx) => {
                    const q = query(collection(db, "users"), where("email", "==", to));
                    const res = await getDocs(q);
                    if (res.empty) throw new Error("–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");

                    const recRef = res.docs[0].ref;
                    tx.update(doc(db, "users", auth.currentUser.uid), { balance: increment(-amt) });
                    tx.update(recRef, { balance: increment(amt) });
                    tx.set(doc(collection(db, "transactions")), {
                        from: auth.currentUser.email, to: to, amount: amt, date: Timestamp.now(), parties: [auth.currentUser.email, to]
                    });
                });
                showNotif('–£—Å–ø–µ—Ö', '–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
                closeModal('send');
            } catch (err) { showNotif('–û—à–∏–±–∫–∞', err.message); }
            finally { btn.disabled = false; btn.textContent = '–û–¢–ü–†–ê–í–ò–¢–¨'; }
        };

        window.copyRef = () => {
            navigator.clipboard.writeText(document.getElementById('ref-url').textContent);
            showNotif('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ', '–°—Å—ã–ª–∫–∞ –≤ –±—É—Ñ–µ—Ä–µ');
        };
        window.copyEmail = () => {
            navigator.clipboard.writeText(auth.currentUser.email);
            showNotif('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ', 'Email –≤ –±—É—Ñ–µ—Ä–µ');
        };
        document.getElementById('btn-logout').onclick = () => signOut(auth);

    </script>
</body>
</html>